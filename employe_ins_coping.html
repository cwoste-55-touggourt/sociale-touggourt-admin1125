<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø¬ØªÙ…Ø§Ø¹ÙŠØ© ØªÙˆÙ‚Ø±Øª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Ù…ÙƒØªØ¨Ø§Øª -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

<script>
        if (sessionStorage.getItem("fromIndex") !== "yes") {
            window.location.href = "index.html";
        }
    </script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #6a11cb, #2575fc);
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh; padding: 15px; overflow-x: hidden;
    }

    /* ====== ØªØµÙ…ÙŠÙ… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ù‚Ù‚) ====== */
    .container {
      position: relative; background: white;
      padding: 35px 40px 10px;
      border-radius: 18px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.2);
      text-align: center; width: 100%; max-width: 580px;
      margin: 0 auto;
    }

    .page-header {
      text-align: center;
      margin-bottom: 25px;
    }

    .page-header .header-logo {
      width: 250px;
      height: auto;
      display: block;
      margin: 0 auto 0px auto;
      filter: contrast(1.05) brightness(1.1);
      animation: pulseLogo 2.5s ease-in-out infinite;
    }

    @keyframes pulseLogo {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.08); }
    }

    .header-text {
      font-size: 20px;
      font-weight: 600;
      line-height: 1.5;
      color: #444;
      margin-bottom: 10px;
    }

    .gradient-title {
      font-size: 20px;
      font-weight: 600;
      background: linear-gradient(to right, #6a11cb, #2575fc);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-top: 0px;
      margin-bottom: 15px;
      display: inline-block;
      position: relative;
    }

    .gradient-title::after {
      content: "";
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(to right, #6a11cb, #2575fc);
      border-radius: 2px;
    }

    /* ====== Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ (ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ­Ù‚Ù‚ ÙÙ‚Ø·) ====== */
    input, select, textarea {
      width: 100%; padding: 12px 14px; margin-bottom: 12px;
      border-radius: 8px; border: 2px solid #e0e0e0;
      font-size: 14px; text-align: center;
      font-family: 'Cairo', sans-serif; font-weight: 500;
    }

    input[readonly] { background:#f5f5f5; }

    input:focus, select:focus {
      outline: none;
      border-color: #2575fc;
    }

    button {
      background: linear-gradient(45deg, #6a11cb, #2575fc);
      color: white; border: none;
      padding: 14px 0; border-radius: 10px;
      font-size: 15px; cursor: pointer;
      font-weight: 600; width: 100%;
      font-family: 'Cairo', sans-serif;
    }

    .small-note { font-size:12px; color:#666; margin-bottom:8px; text-align:center; }

    /* ====== ØªÙ†Ø³ÙŠÙ‚ ØªØ¬Ø§ÙˆØ¨ Ø§Ù„Ù‡ÙˆØ§ØªÙ ====== */
    @media (max-width: 600px) {
      .container {
        padding: 25px 20px 15px;
        border-radius: 14px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      }

      .page-header .header-logo {
        width: 120px;
      }

      .gradient-title {
        font-size: 20px;
        margin-top: 20px;
      }

      input, select, button {
        font-size: 14px;
        padding: 12px;
      }
    }

/* ====== ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø© ====== */
#registrationForm {
  text-align: center;
}

form label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: #333;
  margin-bottom: 5px;
}

input, select, textarea {
  width: 100%;
  padding: 12px 14px;
  margin-bottom: 12px;
  border-radius: 8px;
  border: 2px solid #e0e0e0;
  font-size: 14px;
  text-align: center;
  font-family: 'Cairo', sans-serif;
  font-weight: 500;
}

input[readonly] {
  background: #f5f5f5;
}

input:focus, select:focus {
  outline: none;
  border-color: #2575fc;
}

button {
  background: linear-gradient(45deg, #6a11cb, #2575fc);
  color: white;
  border: none;
  padding: 14px 0;
  border-radius: 10px;
  font-size: 15px;
  cursor: pointer;
  font-weight: 600;
  width: 100%;
  font-family: 'Cairo', sans-serif;
}

.receipt-download-btn {
  margin-top: 12px;
  font-size: 14px;
  background: #28a745 !important;
  color: white !important;
  border: none !important;
  padding: 10px 20px !important;
  border-radius: 8px !important;
  cursor: pointer !important;
  font-weight: 600 !important;
  font-family: 'Cairo', sans-serif !important;
  transition: background 0.3s ease !important;
}

.receipt-download-btn:hover {
  background: #218838 !important;
}

.row {
  display: flex;
  gap: 12px;
  margin-bottom: 10px;
}

.deposit-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  justify-content: center;
  margin-top: 6px;
  min-height: 34px;
  padding: 8px 10px;
  border: 1px dashed #c7d2ff;
  border-radius: 14px;
  background: #f5f7ff;
}

.deposit-tag {
  background: linear-gradient(135deg, #ffffff, #f1f4ff);
  color: #1f2c6d;
  padding: 6px 14px 6px 12px;
  border-radius: 999px;
  font-size: 14px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  border: 1.5px solid #8da2ff;
  box-shadow: 0 3px 8px rgba(92, 110, 200, 0.18);
  cursor: default;
}

.deposit-tag .tag-remove {
  color: #e71d36;
  font-size: 17px;
  line-height: 1;
  cursor: pointer;
  padding: 0 2px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.deposit-year-block {
  margin-top: 10px;
  padding: 10px 12px;
  border: 1px dashed #d2d7ff;
  border-radius: 10px;
}

.deposit-year-block label {
  text-align: center;
  display: block;
  margin-bottom: 6px;
}

.selected-years-label {
  margin-top: 10px;
}

.col {
  flex: 1;
}

@media (max-width: 680px) {
  .row { flex-direction: column; }
}

/* ====== ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Øµ Ù„Ø­Ù‚ÙˆÙ„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙˆØ§ØªÙ ====== */
#phoneDirectorField::placeholder,
#phoneFinancialField::placeholder {
  text-align: center;
  direction: rtl;
}

#phoneDirectorField,
#phoneFinancialField {
  text-align: center;
  direction: ltr;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ù…Ø®ØµØµ Ù„Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
.swal2-popup-custom {
  border-radius: 20px !important;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2) !important;
}

.swal2-title-custom {
  padding: 0 !important;
  margin-bottom: 20px !important;
}

  </style>
</head>

<body>
  <div class="container" id="mainContainer">
    <div class="page-header">
     
      <div class="header-text">
        Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±ÙŠØ© Ø§Ù„Ø¯ÙŠÙ…Ù‚Ø±Ø§Ø·ÙŠØ© Ø§Ù„Ø´Ø¹Ø¨ÙŠØ©<br>
        ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„ÙˆØ·Ù†ÙŠØ©<br>
        Ø§Ù„Ù„Ø¬Ù†Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ© Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø¬ØªÙ…Ø§Ø¹ÙŠØ© Ù„Ø¹Ù…Ø§Ù„ Ø§Ù„ØªØ±Ø¨ÙŠØ©<br>
        Ø§Ù„Ù„Ø¬Ù†Ø© Ø§Ù„ÙˆÙ„Ø§Ø¦ÙŠØ© Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø¬ØªÙ…Ø§Ø¹ÙŠØ© Ù„Ø¹Ù…Ø§Ù„ Ø§Ù„ØªØ±Ø¨ÙŠØ© Ù„ÙˆÙ„Ø§ÙŠØ© ØªÙˆÙ‚Ø±Øª
      </div>
 <img src="https://lh3.googleusercontent.com/d/1AOSzlvuRb-fAO0bqvo412HcHTfpRAX15" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù„Ø¬Ù†Ø©" class="header-logo">
      <h2 class="gradient-title">Ø¨ÙˆØ§Ø¨Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ø®ÙŠÙ…Ø§Øª</h2>
      <input type="text" id="empId" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ" oninput="validateNumber(this)">
      <button onclick="checkEmployee()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>
  </div>

<!-- âœ… Ù‚Ø³Ù… Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø© -->
<div id="registrationForm" style="display:none; margin-top:25px;">

  <form id="empForm">
    
    <!-- Ø§Ù„ØµÙ 1 -->
    <div class="row">
      <div class="col">
        <label for="empIdField">Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
        <input type="text" id="empIdField" name="empId" readonly>
      </div>
      <div class="col">
        <label for="fullName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
        <input type="text" id="fullName" name="fullName" required>
      </div>
    </div>

    <!-- Ø§Ù„ØµÙ 2 -->
    <div class="row">
      <div class="col">
        <label for="rank">Ø§Ù„Ø±ØªØ¨Ø©</label>
        <input type="text" id="rank" name="rank" required>
      </div>
      <div class="col">
        <label for="workPlace">Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„</label>
        <input type="text" id="workPlace" name="workPlace" required>
      </div>
    </div>

    <!-- Ø§Ù„ØµÙ 3 -->
    <div class="row">
      <div class="col">
        <label for="position">Ø§Ù„ØµÙØ©</label>
        <input type="text" id="position" name="position" required>
      </div>
      <div class="col">
        <label for="level">Ø§Ù„Ø·ÙˆØ±</label>
        <input type="text" id="level" name="level" required>
      </div>
    </div>

    <!-- Ø§Ù„ØµÙ 4 -->
    <div class="row">
      <div class="col">
        <label for="district">Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©</label>
        <input type="text" id="district" name="district" required>
      </div>
      <div class="col">
        <label for="municipality">Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©</label>
        <input type="text" id="municipality" name="municipality" required>
      </div>
    </div>

    <!-- Ø§Ù„ØµÙ 5 -->
    <div class="row">
      <div class="col">
        <label for="schoolName">Ø§Ø³Ù… Ø§Ù„Ù…ØªÙˆØ³Ø·Ø©</label>
        <input type="text" id="schoolName" name="schoolName" required>
      </div>
      <div class="col">
        <label for="code">Ø§Ù„Ø±Ù…Ø²</label>
        <input type="text" id="code" name="code" required>
      </div>
    </div>

    <!-- Ø§Ù„ØµÙ 6 -->
    <div class="row">
      <div class="col">
        <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
        <input type="email" id="email" name="email" required>
      </div>
      <div class="col">
        <label for="managerPhone">Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ù…ÙˆØ¸Ù</label>
        <input type="tel" id="managerPhone" name="managerPhone" required>
      </div>
    </div>

    <!-- Ø§Ù„ØµÙ 7 -->
    <div class="row">
      <div class="col">
        <label for="finName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù…Ø³ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ</label>
        <input type="text" id="finName" name="finName" required>
      </div>
      <div class="col">
        <label for="finPhone">Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ</label>
        <input type="tel" id="finPhone" name="finPhone" required>
      </div>
    </div>

    <button type="submit">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
  </form>
</div>



<script>
const firebaseConfig = {
  apiKey: "AIzaSyAkQz9pB2ZNlYIvdlTRvi4try3D8LLXS4g",
  authDomain: "databaseemploye.firebaseapp.com",
  projectId: "databaseemploye",
  storageBucket: "databaseemploye.firebasestorage.app",
  messagingSenderId: "408231477466",
  appId: "1:408231477466:web:e3bf5bd3eaca7cdcd3a5e3",
  measurementId: "G-DW8QJ5B231"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const scriptURL = "https://script.google.com/macros/s/AKfycbyR6ufwjpiaQ5OcMWhW355FIt2ywDxCLzrQ79sNM-MO8mXKjBcUwB9mm8vbrnz3fPsc/exec";

// ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø¹Ø§Ø± ÙˆØ§Ù„ÙˆØµÙ„ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„ÙƒØ§Ø¦Ù† Ø¨Ø­Ø³Ø¨ Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ù„Ø¬Ù†Ø©
const receiptBranding = {
  logoUrl: "https://lh3.googleusercontent.com/d/1AOSzlvuRb-fAO0bqvo412HcHTfpRAX15",
  govTitle: "Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±ÙŠØ© Ø§Ù„Ø¯ÙŠÙ…Ù‚Ø±Ø§Ø·ÙŠØ© Ø§Ù„Ø´Ø¹Ø¨ÙŠØ©",
  ministry: "ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„ÙˆØ·Ù†ÙŠØ©",
  directorate: "Ù…Ø¯ÙŠØ±ÙŠØ© Ø§Ù„ØªØ±Ø¨ÙŠØ© Ù„ÙˆÙ„Ø§ÙŠØ© ØªÙˆÙ‚Ø±Øª",
  committee: "Ø§Ù„Ù„Ø¬Ù†Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ© Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ© Ù„Ø¹Ù…Ø§Ù„ Ø§Ù„ØªØ±Ø¨ÙŠØ©",
  service: "Ø§Ù„Ù„Ø¬Ù†Ø© Ø§Ù„ÙˆÙ„Ø§Ø¦ÙŠØ© Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø¬ØªÙ…Ø§Ø¹ÙŠØ© Ù„Ø¹Ù…Ø§Ù„ Ø§Ù„ØªØ±Ø¨ÙŠØ© Ù„ÙˆÙ„Ø§ÙŠØ© ØªÙˆÙ‚Ø±Øª",
  addressLine: "Ø§Ù„Ù…Ù‚Ø±: Ø­ÙŠ Ø®Ù…ÙŠØ³ØªÙŠØŒ ØªÙˆÙ‚Ø±Øª",
  contactLine: "Ø§Ù„Ù‡Ø§ØªÙ: 91 39 98 030       - Ø§Ù„Ø¨Ø±ÙŠØ¯: cwostetggt55@gmail.com"
};







function validateNumber(input) {
  input.value = input.value.replace(REGEX_PATTERNS.nonDigit, '');
  if (input.value.length > 16) input.value = input.value.slice(0, 16);
}

async function checkEmployee() {
  const empId = document.getElementById("empId").value.trim();

  if (empId.length < 16) {
    Swal.fire({ icon: 'warning', title: 'Ø®Ø·Ø£', text: 'Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙƒÙˆÙ† Ù…Ù† 16 Ø±Ù‚Ù…Ù‹Ø§' });
    return;
  }

  Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

  try {
    const docRef = db.collection("employeescom").doc(empId);
    const docSnap = await docRef.get();

    if (!docSnap.exists) {
      Swal.close();
      await new Promise(resolve => setTimeout(resolve, 100));
      Swal.fire({
  icon: "error",
  title: "âŒ Ø®Ø·Ø£",
  html: `
    Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.<br><br>

    <style>
      /* ÙˆÙ…ÙŠØ¶ Ø¨Ø³ÙŠØ· */
      @keyframes softBlink {
        0% { opacity: 1; }
        50% { opacity: 0.65; }
        100% { opacity: 1; }
      }

      .note-blink {
        animation: softBlink 1.6s infinite ease-in-out;
      }
    </style>

    <div class="note-blink" style="
      padding: 15px;
      background: linear-gradient(135deg, #ffe6e6 0%, #fff0f0 100%);
      color: #d00000;
      border: 2px solid #d00000;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(208, 0, 0, 0.2);
      font-weight: bold;
      font-size: 15px;
      text-align: center; /* â† ÙˆØ¶Ø¹ Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„ÙˆØ³Ø· */
      line-height: 1.7;
    ">
      <span style="color:#d00000; font-size:16px;">Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©:</span>
      <br>
      Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±Ù‚Ù… ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ÙˆØ¸Ù ØµØ­ÙŠØ­Ù‹Ø§ ÙˆØ¸Ù‡Ø±Øª Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŒ ÙˆÙƒØ§Ù† Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ø§Ù„Ø±Ù‚Ù… 
      <strong style="color:#b00000;">1</strong>ØŒ<br>
      ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… 
      <strong style="color:#b00000;">1</strong> 
      Ø¨Ø§Ù„Ø±Ù‚Ù… 
      <strong style="color:#b00000;">0</strong>
      ÙÙ‚Ø· ÙˆØ³ØªÙ†Ø¬Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.
    </div>
  `
});



      return;
    }

    const data = docSnap.data();

    // âœ… Ø£ÙˆÙ„Ø§Ù‹: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ† Ø§Ù„Ø³Ø§Ø¨Ù‚ÙŠÙ†
    const beneficiaryParams = new URLSearchParams();
    beneficiaryParams.append("action", "check_previous_beneficiary");
    beneficiaryParams.append("empId", empId);
    beneficiaryParams.append("loanType", "exceptional");

    try {
      const beneficiaryRes = await fetch(scriptURL, {
        method: "POST",
        body: beneficiaryParams
      });
      const beneficiaryResult = await beneficiaryRes.json();

      if (beneficiaryResult.result === "previous_beneficiary") {
        Swal.close();
        await new Promise(resolve => setTimeout(resolve, 100));
        Swal.fire({
          title: "âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ³Ø¬ÙŠÙ„",
          html: `
            <div style="text-align:center;direction:rtl;font-family:'Cairo',sans-serif;">
              <p style="color:#2c5aa0;font-weight:700;margin-bottom:10px;font-size:18px;">
                ${escapeHtml(data.name || 'Ø§Ù„Ù…ÙˆØ¸Ù')}
              </p>
              <p style="color:#dc3545;font-weight:600;margin-bottom:15px;">
                ${beneficiaryResult.message || 'Ø£Ù†Øª Ù…Ø³ØªÙÙŠØ¯(Ø©) Ù…Ù† Ø§Ù„Ù…Ø®ÙŠÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©'}
              </p>
              <p style="color:#666;font-size:14px;">
               Ù„Ø§ ÙŠØ­Ù‚Ù‘ Ù„Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø°ÙŠ Ø§Ø³ØªÙØ§Ø¯ Ù…Ù† Ù…Ø®ÙŠÙ…Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ© Ø®Ù„Ø§Ù„ Ø§Ù„Ø³Ù†Ø© Ù†ÙØ³Ù‡Ø§ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ØŒ ÙˆØ°Ù„Ùƒ Ø¹Ù…Ù„Ø§Ù‹ Ø¨Ø§Ù„Ø£Ø­ÙƒØ§Ù… Ø§Ù„Ù…Ø¹Ù…ÙˆÙ„ Ø¨Ù‡Ø§.
              </p>
            </div>
          `,
          icon: "error",
          confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
          confirmButtonColor: "#dc3545"
        });
        return;
      }

      // âœ… Ø«Ø§Ù†ÙŠØ§Ù‹: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ³Ø¬ÙŠÙ„ Ø³Ø§Ø¨Ù‚ ÙÙŠ Ø§Ù„Ù…Ø®ÙŠÙ…Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      const params = new URLSearchParams();
      params.append("action", "check_existing");
      params.append("empId", empId);
      params.append("loanType", "exceptional"); // âœ… Ù†ÙˆØ¹ Ø§Ù„Ø³Ù„ÙØ©: Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠØ©

      const res = await fetch(scriptURL, {
        method: "POST",
        body: params
      });
      const result = await res.json();

      await       Swal.close();
      await new Promise(resolve => setTimeout(resolve, 100));

      if (result.result === "exists") {
        const d = result.data || {};
        const birthLine = formatToDayMonthYear(d.birthDate || d.diz || '');
        const childrenValue = (d.childrenCount ?? "").toString().trim();
        const isFamilyStatusRequiringChildren = ["Ù…ØªØ²ÙˆØ¬(Ø©)", "Ù…Ø·Ù„Ù‚(Ø©)"].includes(d.maritalStatus);
        const hasChildrenValue = childrenValue !== "";
        const shouldRenderChildren = hasChildrenValue || isFamilyStatusRequiringChildren;
        const childrenLine = shouldRenderChildren ? `<b>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆÙ„Ø§Ø¯:</b> ${childrenValue || "0"}<br>` : "";
        const dualSectorLine = isFamilyStatusRequiringChildren
          ? `<b>Ø«Ù†Ø§Ø¦ÙŠ Ø§Ù„Ù‚Ø·Ø§Ø¹:</b> ${d.dualSector || ''}<br>`
          : "";
        const spouseStatusLine = isFamilyStatusRequiringChildren && d.spouseStatus
          ? `<b>ØµÙØ© Ø§Ù„Ø²ÙˆØ¬(Ø©):</b> ${d.spouseStatus}<br>`
          : "";
        // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø²ÙˆØ¬ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø«Ù†Ø§Ø¦ÙŠ Ø§Ù„Ù‚Ø·Ø§Ø¹ = Ù†Ø¹Ù…
        let spouseBlock = "";
        if (d.dualSector === "Ù†Ø¹Ù…") {
          if (d.spouseEmpId) {
            spouseBlock += `<b>Ø±Ù‚Ù… ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø²ÙˆØ¬(Ø©):</b> ${d.spouseEmpId}<br>`;
          }
          if (d.spouseName) {
            spouseBlock += `<b>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø²ÙˆØ¬(Ø©):</b> ${d.spouseName}<br>`;
          }
        }
        const guaranteeBlock = d.guarantee
          ? `<b>Ø§Ù„ÙƒÙØ§Ù„Ø©:</b> ${d.guarantee}<br>${d.guarantee === "Ù†Ø¹Ù…" && d.guaranteedCount ? `<b>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙØ±Ø§Ø¯ Ø§Ù„Ù…ÙƒÙÙˆÙ„ÙŠÙ†:</b> ${d.guaranteedCount}<br>` : ''}`
          : "";
        const destinationLine = d.destination ? `<b>Ø§Ù„ÙˆØ¬Ù‡Ø©:</b> ${d.destination}<br>` : "";
        const cohortLine = d.cohort ? `<b>Ø§Ù„ÙÙˆØ¬:</b> ${d.cohort}<br>` : "";

        Swal.fire({
          title: "âš ï¸ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§",
          html: `
            <div style="text-align:right;direction:rtl;font-family:'Cairo',sans-serif;">
              <b>Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ:</b> ${d.empId || ''}<br>
              <b>Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù„Ù‚Ø¨:</b> ${d.name || ''}<br>
              <b>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:</b> ${birthLine}<br>
              <b>Ø§Ù„Ø±ØªØ¨Ø©:</b> ${d.grade || ''}<br>
              <b>Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„:</b> ${d.place || ''}<br>
              <b>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</b> <span style="direction:ltr;unicode-bidi:bidi-override;display:inline-block;text-align:left;">${formatPhoneNumber(d.personalPhone || '')}</span><br>
              <b>Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©:</b> ${d.daira || ''}<br>
              <b>Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©:</b> ${d.baladiya || ''}<br>
              <b>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„ÙŠØ©:</b> ${d.maritalStatus || ''}<br>
              ${childrenLine}
              ${dualSectorLine}
              ${spouseStatusLine}
              ${spouseBlock}
              ${guaranteeBlock}
              ${destinationLine}
              ${cohortLine}
              <b>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</b> <span style="direction:ltr;unicode-bidi:bidi-override;display:inline-block;text-align:left;">${formatDateFromISO(d.date || '')}</span>${d.modificationDate ? `<br><b>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:</b> <span style="direction:ltr;unicode-bidi:bidi-override;display:inline-block;text-align:left;">${formatDateFromISO(d.modificationDate || '')}</span>` : ''}
            </div>
            <button type="button" class="receipt-download-btn" id="existingReceiptBtn">ØªØ­Ù…ÙŠÙ„ ÙˆØµÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>`,
          icon: "warning",
          showCancelButton: true,
          showDenyButton: true,
          confirmButtonText: "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
          denyButtonText: "Ø­Ø°Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„",
          cancelButtonText: "Ø¥ØºÙ„Ø§Ù‚",
          confirmButtonColor: "#FFAD29",
          denyButtonColor: "#dc3545",
          didOpen: () => {
            attachReceiptButton("existingReceiptBtn", d, {
              actionSource: "Ø¹Ø±Ø¶ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø­ÙÙˆØ¸",
              registrationDate: d.date,
              modificationDate: d.modificationDate
            });
          }
        }).then((result) => {
          if (result.isConfirmed) {
            // Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø© Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
            showEditForm(empId, data, d);
          } else if (result.isDenied) {
            // Ø­Ø°Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„
            deleteRegistration(empId);
          }
        });
        return; // ğŸŸ¥ Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø¥Ù„Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ ØªØ¹Ø¯ÙŠÙ„
      }

      // ğŸŸ¢ ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØªØ³Ø¬ÙŠÙ„ Ø³Ø§Ø¨Ù‚ â†’ Ù†Ø³Ù…Ø­ Ø¨Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
      Swal.fire({
        title: "âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­",
        html: `
          <b>Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù„Ù‚Ø¨:</b> ${escapeHtml(data.name)}<br>
          <b>Ø§Ù„Ø±ØªØ¨Ø©:</b> ${escapeHtml(data.grade)}<br>
          <b>Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„:</b> ${escapeHtml(data.place)}<br>
          
        `,
        icon: "success",
        confirmButtonText: "Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„"
      }).then(() => showForm(empId, data));

    } catch (err) {
      Swal.close();
      await new Promise(resolve => setTimeout(resolve, 100));
      Swal.fire({
        icon: "error",
        title: "âŒ Ø®Ø·Ø£",
        text: "ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©",
        confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
        allowOutsideClick: true,
        allowEscapeKey: true
      });
      console.error("check_existing error:", err);
    }

  } catch (err) {
    Swal.close();
    await new Promise(resolve => setTimeout(resolve, 100));
    Swal.fire({
      icon: "error",
      title: "âŒ Ø®Ø·Ø£",
      text: "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†",
      confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
      allowOutsideClick: true,
      allowEscapeKey: true
    });
    console.error("Firebase error:", err);
  }
}


function escapeHtml(str){ 
  const s = String(str || '');
  return s.replace(REGEX_PATTERNS.htmlEscape, s => '&#' + s.charCodeAt(0) + ';'); 
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† ØµÙŠØºØ© ISO Ø¥Ù„Ù‰ ØµÙŠØºØ© "HH:mm:ss ll YYYY-MM-DD"
function formatDateFromISO(dateStr) {
  if (!dateStr) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
  
  try {
    let date;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨ØµÙŠØºØ© ISO (Ù…Ø«Ù„: 2025-11-14T12:17:26.000Z)
    if (dateStr.includes('T')) {
      date = new Date(dateStr);
    } else if (dateStr.includes('ll') && dateStr.includes('-') && dateStr.includes(':')) {
      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¨ØµÙŠØºØ© "HH:mm:ss ll YYYY-MM-DD" Ù†Ø¹ÙŠØ¯Ù‡ ÙƒÙ…Ø§ Ù‡Ùˆ
      return dateStr;
    } else if (dateStr.includes('-') && dateStr.includes(' ')) {
      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¨ØµÙŠØºØ© "dd-MM-yyyy HH:mm:ss" Ù†Ø¹ÙŠØ¯Ù‡ ÙƒÙ…Ø§ Ù‡Ùˆ
      return dateStr;
    } else {
      // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­ÙˆÙŠÙ„Ù‡ ÙƒØªØ§Ø±ÙŠØ®
      date = new Date(dateStr);
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
    if (isNaN(date.getTime())) {
      return dateStr;
    }
    
    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ ØµÙŠØºØ© "HH:mm:ss ll YYYY-MM-DD"
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');
    
    return `${hours}:${minutes}:${seconds} ll ${year}-${month}-${day}`;
  } catch (err) {
    return dateStr; // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ù†Ø¹ÙŠØ¯ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£ØµÙ„ÙŠ
  }
}

function formatToDayMonthYear(dateStr) {
  if (!dateStr && dateStr !== 0) return '';

  // Ø¯Ø¹Ù… ÙƒØ§Ø¦Ù†Ø§Øª Timestamp Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† ÙØ§ÙŠØ±Ø¨ÙŠØ²
  if (typeof dateStr === 'object') {
    if (typeof dateStr.toDate === 'function') {
      return formatDateObject(dateStr.toDate());
    }
    if (typeof dateStr.seconds === 'number') {
      const millis = dateStr.seconds * 1000 + Math.floor((dateStr.nanoseconds || 0) / 1e6);
      return formatDateObject(new Date(millis));
    }
  }

  const trimmed = String(dateStr).trim();
  if (!trimmed) return '';
  if (REGEX_PATTERNS.dateDDMMYYYY.test(trimmed)) return trimmed;
  const isoMatch = trimmed.match(REGEX_PATTERNS.dateISO);
  if (isoMatch) {
    const [, year, month, day] = isoMatch;
    return `${day}-${month}-${year}`;
  }
  if (trimmed.includes('T')) {
    const date = new Date(trimmed);
    if (!isNaN(date.getTime())) {
      return formatDateObject(date);
    }
  }
  return trimmed;
}

function formatDateObject(date) {
  if (!(date instanceof Date) || isNaN(date.getTime())) return '';
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  return `${day}-${month}-${year}`;
}

/* ----- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© (Ù…ØªÙˆØ³Ø· / Ø«Ø§Ù†ÙˆÙŠ) ----- 
   ÙŠÙ…ÙƒÙ† ØªÙˆØ³ÙŠØ¹ Ù‡Ø°Ø§ Ø§Ù„ÙƒØ§Ø¦Ù† Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø£Ùˆ Ø¬Ù„Ø¨Ù‡ Ù…Ù† Ù…Ù„Ù Ø®Ø§Ø±Ø¬ÙŠ.
*/
window.institutionsByDaaira = {
  "ØªÙˆÙ‚Ø±Øª": {
    "Ù…ØªÙˆØ³Ø·": [
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø³Ø¹Ø¯ Ø¨Ù† Ø£Ø¨ÙŠ ÙˆÙ‚Ø§Øµ ØªÙ‚Ø±Øª", code: "551201" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ø¹Ù„ÙŠ ØªÙˆÙ‚Ø±Øª", code: "551202" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ù…Ø­Ù…Ø¯ Ø§Ù„Ø£Ù…ÙŠÙ† Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ ØªÙ‚Ø±Øª", code: "551203" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø´ÙŠØ® Ø§Ù„Ù…Ù‚Ø±Ø§Ù†ÙŠ ØªØ¨Ø³Ø¨Ø³Øª", code: "551204" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø¨Ù† Ù‡Ø¯ÙŠØ© Ø§Ù„Ù…Ø¯Ù†ÙŠ Ø§Ù„Ù†Ø²Ù„Ø©", code: "551205" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø¹Ø¨Ø¯ Ø§Ù„Ø­Ù…ÙŠØ¯ Ø¨Ù† Ø¨Ø§Ø¯ÙŠØ³ ØªÙˆÙ‚Ø±Øª", code: "551206" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø­Ù…Ø²Ø© Ø¨Ù† Ø¹Ø¨Ø¯ Ø§Ù„Ù…Ø·Ù„Ø¨ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ø§Ø¨Ø¯ÙŠØ©", code: "551207" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ù†ØµØ±Ø§Øª Ø­Ø´Ø§Ù†ÙŠ ØªØ¨Ø³Ø¨Ø³Øª", code: "551208" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø¹ÙŠØ³Ø§Øª Ø§ÙŠØ¯ÙŠØ± Ø§Ù„Ø¨Ù‡Ø¬Ø© ØªØ¨Ø³Ø¨Ø³Øª", code: "551209" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© ØªØ¬ÙŠÙ†ÙŠ Ù…Ø­Ù…Ø¯ Ø¹ÙŠÙ† Ø§Ù„ØµØ­Ø±Ø§Ø¡ Ø§Ù„Ù†Ø²Ù„Ø©", code: "551210" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø§Ø¨Ù† Ø±Ø´Ø¯ Ø­ÙŠ Ø§Ù„Ø¹Ø±Ù‚ÙˆØ¨ ØªÙˆÙ‚Ø±Øª", code: "551211" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø±Ø¶Ø§ Ø­ÙˆØ­Ùˆ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ø§Ø¨Ø¯ÙŠØ©", code: "551212" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ù…ÙŠØ¹Ø§Ø¯ÙŠ ÙØ®Ø± Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ù†Ø²Ù„Ø©", code: "551213" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø¹Ø·Ø§Ù„ÙŠ Ù…Ø­Ù…Ø¯ Ø§Ù„ØµØºÙŠØ± Ø³ÙŠØ¯ÙŠ Ù…Ù‡Ø¯ÙŠ Ø§Ù„Ù†Ø²Ù„Ø©", code: "551214" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ù…Ø­Ù…Ø¯ Ø¹Ù…Ø±Ø§Ù† Ø¨ÙˆÙ„ÙŠÙØ© Ø­ÙŠ Ø§Ù„Ø±Ù…Ø§Ù„ ØªÙˆÙ‚Ø±Øª", code: "551215" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø¹Ø¨Ø¯ Ø§Ù„Ù…Ø¤Ù…Ù† Ø¨Ù† Ø¹Ù„ÙŠ Ø§Ù„Ù†Ø²Ù„Ø©", code: "551216" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø¨Ù† Ø§Ù„Ø²Ø§ÙˆÙŠ Ø¹Ù„ÙŠ ØªØ¨Ø³Ø¨Ø³Øª", code: "551217" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø¨Ø´ÙŠØ± Ø§Ù„Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ…ÙŠ ØªÙˆÙ‚Ø±Øª", code: "551218" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø­ÙŠ 5 Ø¬ÙˆÙŠÙ„ÙŠØ© Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ø§Ø¨Ø¯ÙŠØ©", code: "551219" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø¨Ù† Ø­ÙŠØ²ÙŠØ© Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø¹ÙŠÙ† Ø§Ù„ØµØ­Ø±Ø§Ø¡ 1 Ø§Ù„Ù†Ø²Ù„Ø©", code: "551220" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø¨Ù† Ù‚Ù„ÙŠØ© Ù…Ø­Ù…Ø¯ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ø§Ø¨Ø¯ÙŠØ©", code: "551221" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© ØªÙ…Ø±Ù†ÙŠ Ù…Ø­Ù…Ø¯ ØªÙˆÙ‚Ø±Øª", code: "551222" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø´Ø§ÙˆØ´ Ù…Ø­Ù…Ø¯ ØªØ¨Ø³Ø¨Ø³Øª", code: "551223" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ø¬Ø§Ù‡Ø¯ Ø§Ù„ØªØ¬Ø§Ù†ÙŠ Ø§Ù„ØµØ§Ø¯Ù‚ Ø§Ù„Ù†Ø²Ù„Ø©", code: "551224" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø®Ø±ÙˆØ¨ÙŠ Ù…Ø­Ù…Ø¯ Ù„Ø®Ø¶Ø± Ø§Ù„Ù†Ø²Ù„Ø©", code: "551225" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ø¬Ø§Ù‡Ø¯ Ø³Ø¨Ù‚Ø§Ù‚ Ø§Ù„Ø¹ÙŠØ¯ ØªÙˆÙ‚Ø±Øª", code: "551226" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø¯Ù‚Ø¹Ø© Ø§Ù„Ø·Ø§Ù‡Ø± ØªØ¨Ø³Ø¨Ø³Øª", code: "551227" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø¨Ø¯ÙˆØ¯Ø© Ù…Ø¹Ù…Ø± Ø¨Ù† Ø¹Ù„ÙŠ Ø§Ù„Ù†Ø²Ù„Ø©", code: "551228" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø¯Ø§Ø´Ø± Ø§Ù„Ø­Ø§Ø¬ Ø­ÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ ØªÙˆÙ‚Ø±Øª", code: "551229" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ø¬Ø§Ù‡Ø¯ Ø±ÙˆØ§Øµ Ù…Ø­Ù…Ø¯ Ø­ÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ ØªÙˆÙ‚Ø±Øª", code: "551230" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ø¬Ø§Ù‡Ø¯ Ø¨ÙˆÙ„ÙŠÙØ© Ù… Ø§Ù„Ø¹ÙŠØ¯Ø­ÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ ØªÙˆÙ‚Ø±Øª", code: "551231" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ø¬Ø§Ù‡Ø¯ Ø¹Ù…Ø§Ø±ÙŠ Ø§Ù„Ø³Ø§ÙŠØ­Ø­ÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ ØªÙˆÙ‚Ø±Øª", code: "551232" }
    ],
    "Ø«Ø§Ù†ÙˆÙŠ": [
      { name: "Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ø£Ù…ÙŠØ± Ø¹Ø¨Ø¯ Ø§Ù„Ù‚Ø§Ø¯Ø± ØªÙˆÙ‚Ø±Øª", code: "551101" },
      { name: "Ø«Ø§Ù†ÙˆÙŠØ© Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ø§Ù† Ø§Ù„ÙƒÙˆØ§ÙƒØ¨ÙŠ ØªØ¨Ø³Ø¨Ø³Øª", code: "551102" },
      { name: "Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ø­Ø³Ù† Ø¨Ù† Ø§Ù„Ù‡ÙŠØ«Ù… Ø§Ù„Ù†Ø²Ù„Ø©", code: "551103" },
      { name: "Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ø¨Ø´ÙŠØ± Ø§Ù„Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ…ÙŠ ØªØ¨Ø³Ø¨Ø³Øª", code: "551104" },
      { name: "Ø«Ø§Ù†ÙˆÙŠØ© Ù‡ÙˆØ§Ø±ÙŠ Ø¨ÙˆÙ…Ø¯ÙŠÙ† Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ø§Ø¨Ø¯ÙŠØ©", code: "551105" },
      { name: "Ø«Ø§Ù†ÙˆÙŠØ© Ø£Ø¨Ùˆ Ø¨ÙƒØ± Ø¨Ù„Ù‚Ø§ÙŠØ¯ Ø§Ù„Ù†Ø²Ù„Ø©", code: "551106" },
      { name: "Ø«Ø§Ù†ÙˆÙŠØ© Ù„Ø²Ù‡Ø§Ø±ÙŠ ØªÙˆÙ†Ø³ÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ø§Ø¨Ø¯ÙŠØ©", code: "551107" },
      { name: "Ø«Ø§Ù†ÙˆÙŠØ© Ø¨ÙˆØ®Ø§Ø±ÙŠ Ø¹Ø¨Ø¯ Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ù†Ø²Ù„Ø©", code: "551108" },
      { name: "Ø«Ø§Ù†ÙˆÙŠØ© Ø¹Ø¨ÙˆØ¯Ø© Ø¹Ù„ÙŠ -Ø­ÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ - ØªÙˆÙ‚Ø±Øª", code: "551109" },
      { name: "Ø«Ø§Ù†ÙˆÙŠØ© Ù…Ø³ØºÙˆÙ†ÙŠ Ù… Ø§Ù„ØµØ§Ù„Ø­ - Ø­ÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„", code: "551110" }
    ]
  },

  "Ø§Ù„Ø­Ø¬ÙŠØ±Ø©": {
    "Ù…ØªÙˆØ³Ø·": [
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø§Ø¨Ù† Ø³ÙŠÙ†Ø§ Ø§Ù„Ø­Ø¬ÙŠØ±Ø©", code: "552201" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ù„Ø®Ø¶Ø§Ø±ÙŠ Ù„Ø®Ø¶Ø± Ø§Ù„Ø¹Ø§Ù„ÙŠØ©", code: "552202" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø²ÙˆØ§Ø¨Ø±ÙŠ Ù…Ø³Ø¹ÙˆØ¯ Ù„Ù‚Ø±Ø§Ù Ø§Ù„Ø­Ø¬ÙŠØ±Ø©", code: "552203" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø³Ø§ÙŠØ­ Ø¨Ù† Ø¹ÙŠØ³Ù‰ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø³Ø§ÙŠØ­ Ø§Ù„Ø¹Ø§Ù„ÙŠØ©", code: "552204" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø¨Ù† Ø´ÙˆÙŠØ­Ø© Ø­Ù…Ø²Ø© Ø§Ù„Ø­Ø¬ÙŠØ±Ø©", code: "552205" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø´Ù„ØºÙˆÙ… Ø¨Ø´ÙŠØ± Ø§Ù„Ø´Ù‚Ø© -Ø§Ù„Ø¹Ø§Ù„ÙŠØ©-", code: "552206" },
      { name: "Ø§Ù„Ù…Ø¬Ø§Ù‡Ø¯ Ø´Ø¹ÙŠØ¨ Ø§Ù„Ø£Ø®Ø¶Ø± Ø§Ù„Ø­Ø¬ÙŠØ±Ø©", code: "552206" }
    ],
    "Ø«Ø§Ù†ÙˆÙŠ": [
      { name: "Ø«Ø§Ù†ÙˆÙŠØ© Ø·Ø§Ø±Ù‚ Ø¨Ù† Ø²ÙŠØ§Ø¯ Ø§Ù„Ø­Ø¬ÙŠØ±Ø©", code: "552101" },
      { name: "Ø«Ø§Ù†ÙˆÙŠØ© Ø¨Ø³Ø§Ø³ÙŠ Ù…Ø­Ù…Ø¯ Ø§Ù„ØµØºÙŠØ± Ø§Ù„Ø¹Ø§Ù„ÙŠØ©", code: "552102" },
      { name: "Ø«Ø§Ù†ÙˆÙŠØ© Ù„Ø­Ø³ÙŠÙ†ÙŠ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø­Ø¬ÙŠØ±Ø©", code: "552103" },
      { name: "Ø«Ø§Ù†ÙˆÙŠØ© Ø¨Ø§Ù„Ø¶ÙŠØ§Ù Ù…Ø­Ù…Ø¯ Ù„Ù‚Ø±Ø§Ù Ø§Ù„Ø­Ø¬ÙŠØ±Ø©", code: "552104" }
    ]
  },

  "Ø§Ù„Ø·ÙŠØ¨Ø§Øª": {
    "Ù…ØªÙˆØ³Ø·": [
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø£Ø­Ù…Ø¯ Ø²Ø¨Ø§Ù†Ø© Ø§Ù„Ø·ÙŠØ¨Ø§Øª", code: "553201" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ù…ÙˆØ³Ù‰ Ø¨Ù† Ù†ØµÙŠØ± Ø§Ù„Ù…Ù†Ù‚Ø±", code: "553202" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø·Ø§Ø±Ù‚ Ø¨Ù† Ø²ÙŠØ§Ø¯ Ø¨Ù† Ù†Ø§ØµØ±", code: "553203" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ù†ØªØ§Ø±ÙŠ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¯Ù„ÙŠÙ„Ø¹ÙŠ Ø§Ù„Ø·ÙŠØ¨Ø§Øª", code: "553204" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø¹Ù‚ÙˆÙ† Ù…Ø­Ù…Ø¯ Ø§Ù„ÙƒØ¨ÙŠØ± Ø§Ù„Ø·ÙŠØ¨Ø§Øª", code: "553205" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ù…Ø¹Ù…Ø±ÙŠ Ù…Ø­Ù…Ø¯ Ø¨Ù† Ù†Ø§ØµØ±", code: "553206" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø¹ÙŠØ¯ Ø²Ù‚Ø±ÙŠØ± Ø§Ù„Ù…Ù†Ù‚Ø±", code: "553207" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø¨Ù„Ø¹Ø¬Ø§Ù„ Ø£Ø­Ù…Ø¯ Ø§Ù„Ø®Ø¨Ù†Ø© Ø§Ù„Ø·ÙŠØ¨Ø§Øª", code: "553208" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ø¬Ø§Ù‡Ø¯ Ø§Ù„Ø®Ø°ÙŠØ± Ø£Ø­Ù…Ø¯ Ø§Ù„Ù…Ù†Ù‚Ø±", code: "553209" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ø¬Ø§Ù‡Ø¯ Ø±Ø§Ø¨Ø­ÙŠ Ø§Ù„Ø¹ÙŠØ¯ Ø§Ù„Ù…Ù†Ù‚Ø±", code: "553210" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ø¬Ø§Ù‡Ø¯ Ø¨ÙƒØ§Ø±ÙŠ Ø¹ Ø§Ù„Ù‚Ø§Ø¯Ø± Ø¯Ù„ÙŠÙ„ÙŠØ¹ÙŠ Ø§Ù„Ø·ÙŠØ¨Ø§Øª", code: "553211" }
    ],
    "Ø«Ø§Ù†ÙˆÙŠ": [
      { name: "Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ø¨Ù† Ø±Ø´ÙŠÙ‚ Ø§Ù„Ù‚ÙŠØ±ÙˆØ§Ù†ÙŠ Ø§Ù„Ø·ÙŠØ¨Ø§Øª", code: "553101" },
      { name: "Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ù…Ù†Ù‚Ø± - Ø¯Ù‚Ø¹Ø© Ø¹Ù„ÙŠ Ø§Ù„Ù…Ù†Ù‚Ø±", code: "553102" },
      { name: "Ø«Ø§Ù†ÙˆÙŠØ© Ø¹Ø¨ÙŠØ¯ Ø£Ø­Ù…Ø¯ Ø¨Ù† Ù†Ø§ØµØ±", code: "553103" },
      { name: "Ø«Ø§Ù†ÙˆÙŠØ© Ø²Ù‚ÙˆÙ†ÙŠ Ø§Ù„ØµØºÙŠØ± Ø§Ù„Ø¯Ù„ÙŠÙ„ÙŠØ¹ÙŠ Ø§Ù„Ø·ÙŠØ¨Ø§Øª", code: "553104" }
    ]
  },

  "Ø§Ù„Ù…Ù‚Ø§Ø±ÙŠÙ†": {
    "Ù…ØªÙˆØ³Ø·": [
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„ÙØ±Ø§Ø¨ÙŠ Ø§Ù„Ù…Ù‚Ø§Ø±ÙŠÙ†", code: "554201" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø·ÙØ­ÙŠ Ù…Ø³Ø¹ÙˆØ¯ Ø³ÙŠØ¯ÙŠ Ø³Ù„ÙŠÙ…Ø§Ù†", code: "554202" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø¨Ù„Ø­Ø§Ø±Ø« Ù…Ø­Ù…Ø¯ Ø§Ù„Ø³Ø§ÙŠØ­ Ø³ÙŠØ¯ÙŠ Ø³Ù„ÙŠÙ…Ø§Ù†", code: "554203" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø³ÙˆÙÙŠ Ø§Ù„Ù‡Ø§Ø´Ù…ÙŠ Ø§Ù„Ø·ÙŠØ¨Ø§Øª", code: "554204" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø´Ù‡ÙŠØ¯ Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ø§Ù† Ù‚ÙˆØªØ§Ù„ Ø§Ù„Ù‚ØµÙˆØ± Ø§Ù„Ù…Ù‚Ø§Ø±ÙŠÙ†", code: "554205" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø´Ù‡ÙŠØ¯ Ø£Ø­Ù…ÙŠØ¯Ø© Ø¨ÙˆØ­ÙØµ Ø§Ù„Ù…Ù‚Ø§Ø±ÙŠÙ†", code: "554206" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø¨Ø±ÙƒØ¨ÙŠØ© Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø²Ø§Ù‚ Ø§Ù„Ù…Ù‚Ø§Ø±ÙŠÙ†", code: "554207" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø´Ù‡ÙŠØ¯ ØªÙ…Ø§Ø³ÙŠÙ†ÙŠ Ø¹ Ø§Ù„Ø±Ø­Ù…Ø§Ù† Ù„Ù‡Ø±ÙŠÙ‡ÙŠØ±Ø© Ø§Ù„Ù…Ù‚Ø§Ø±ÙŠÙ†", code: "554208" }
    ],
    "Ø«Ø§Ù†ÙˆÙŠ": [
      { name: "Ø«Ø§Ù†ÙˆÙŠØ© Ø®Ø§Ù„Ø¯ Ø¨Ù† Ø§Ù„ÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ù‚Ø§Ø±ÙŠÙ†", code: "554101" },
      { name: "Ø«Ø§Ù†ÙˆÙŠØ© Ø¨Ù† Ø¹Ù…Ø± Ø§Ù„Ù†ÙˆÙŠ Ø³ÙŠØ¯ÙŠ Ø³Ù„ÙŠÙ…Ø§Ù†", code: "554102" },
      { name: "Ø«Ø§Ù†ÙˆÙŠØ© Ø¹Ù…ÙŠØ´ Ø³Ø¹Ø¯ÙˆÙ† Ø§Ù„Ù…Ù‚Ø§Ø±ÙŠÙ†", code: "554103" }
    ]
  },

  "ØªÙ…Ø§Ø³ÙŠÙ†": {
    "Ù…ØªÙˆØ³Ø·": [
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø¹Ù…Ø± Ø¨Ù† Ø§Ù„Ø®Ø·Ø§Ø¨ ØªÙ…Ø§Ø³ÙŠÙ†", code: "555201" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ù…ÙˆÙ„Ø§ØªÙŠ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø³Ø§ÙŠØ­ Ø¨Ù„Ø¯Ø© Ø¹Ù…Ø±", code: "555202" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø£Ø¨Ùˆ Ø¨ÙƒØ± Ø§Ù„Ø±Ø§Ø²ÙŠ Ø§Ù„Ø¨Ø­ÙˆØ± ØªÙ…Ø§Ø³ÙŠÙ†", code: "555203" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ù‚ÙˆÙ†ÙŠ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø·ÙŠØ¨ Ø³ÙŠØ¯ÙŠ Ø¹Ø§Ù…Ø± ØªÙ…Ø§Ø³ÙŠÙ†", code: "555204" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ù…Ø¹Ø±ÙƒØ© Ù‚Ø±Ø¯Ø§Ø´ Ø¨Ù„Ø¯Ø© Ø¹Ù…Ø±", code: "555205" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ù…Ø­Ù…Ø¯ Ø§Ù„ØµØ¯ÙŠÙ‚ Ø¨Ù† ÙŠØ­ÙŠ Ø­ÙŠ Ø§Ù„ÙƒØ¯ÙŠØ© ØªÙ…Ø§Ø³ÙŠÙ†", code: "555206" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø¨Ø±ÙƒØ© Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø²Ø§Ù‚ Ù‚ÙˆÙ‚ Ø¨Ù„Ø¯Ø© Ø¹Ù…Ø±", code: "555207" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø¨Ø¯ÙˆØ¯Ø© Ø§Ù„Ø³Ø§ÙŠØ­ ØªÙ…Ù„Ø§Ø­Øª ØªÙ…Ø§Ø³ÙŠÙ†", code: "555208" },
      { name: "Ù…ØªÙˆØ³Ø·Ø© Ø¹ Ø§Ø¨Ù† Ø¨Ø§Ø¯ÙŠØ³ Ù‚ÙˆÙ‚ Ø¨Ù„Ø¯Ø© Ø¹Ù…Ø±", code: "555209" }
    ],
    "Ø«Ø§Ù†ÙˆÙŠ": [
      { name: "Ø«Ø§Ù†ÙˆÙŠØ© Ù…ÙØ¯ÙŠ Ø²ÙƒØ±ÙŠØ§ ØªÙ…Ø§Ø³ÙŠÙ†", code: "555101" },
      { name: "Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ø¹ÙŠØ¯ Ø¨Ù† Ø§Ù„ØµØ­Ø±Ø§ÙˆÙŠ Ø¨Ù„Ø¯Ø© Ø¹Ù…Ø±", code: "555102" },
      { name: "Ø«Ø§Ù†ÙˆÙŠØ© Ù‚ÙˆÙŠØ¯Ø±ÙŠ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¹ÙŠØ¯ ØªÙ…Ø§Ø³ÙŠÙ†", code: "555103" },
      { name: "Ø«Ø§Ù†ÙˆÙŠØ© ØªØ¬ÙŠÙ†ÙŠ Ù…Ø­Ù…Ø¯ Ù„Ø®Ø¶Ø± Ø¨Ù„Ø¯Ø© Ø¹Ù…Ø±", code: "555104" },
      { name: "Ø«Ø§Ù†ÙˆÙŠØ© Ù…Ø§Ù„Ùƒ Ø¨Ù† Ù†Ø¨ÙŠ Ù‚ÙˆÙ‚", code: "555105" }
    ]
  }
};

/* ----- Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¨Ù„Ø¯ÙŠØ§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© (ÙƒÙ…Ø§ ÙÙŠ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚) ----- */
window.baladiyaMap = {
  "ØªÙˆÙ‚Ø±Øª": ["ØªÙˆÙ‚Ø±Øª", "Ø§Ù„Ù†Ø²Ù„Ø©", "ØªØ¨Ø³Ø¨Ø³Øª", "Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ø§Ø¨Ø¯ÙŠØ©"],
  "ØªÙ…Ø§Ø³ÙŠÙ†": ["ØªÙ…Ø§Ø³ÙŠÙ†", "Ø¨Ù„Ø¯Ø© Ø¹Ù…Ø±"],
  "Ø§Ù„Ù…Ù‚Ø§Ø±ÙŠÙ†": ["Ø§Ù„Ù…Ù‚Ø§Ø±ÙŠÙ†", "Ø³ÙŠØ¯ÙŠ Ø³Ù„ÙŠÙ…Ø§Ù†"],
  "Ø§Ù„Ø­Ø¬ÙŠØ±Ø©": ["Ø§Ù„Ø­Ø¬ÙŠØ±Ø©", "Ø§Ù„Ø¹Ø§Ù„ÙŠØ©"],
  "Ø§Ù„Ø·ÙŠØ¨Ø§Øª": ["Ø§Ù„Ø·ÙŠØ¨Ø§Øª", "Ø§Ù„Ù…Ù†Ù‚Ø±", "Ø§Ø¨Ù† Ù†Ø§ØµØ±"]
};

// Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
let isEditMode = false;
let originalRegistrationDate = null; // ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£ØµÙ„ÙŠ
let originalModificationDate = null; // ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£ØµÙ„ÙŠ (Ø¥Ù† ÙˆØ¬Ø¯)
let currentModificationDate = null; // ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø§Ù„Ø°ÙŠ ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)
let spouseLookupTimeout = null;

// âœ… ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡: ØªØ®Ø²ÙŠÙ† Ù…Ø¤Ù‚Øª Ù„Ù„Ø¹Ù†Ø§ØµØ± DOM
const domCache = {};
const getEl = (id) => {
  if (!domCache[id]) domCache[id] = document.getElementById(id);
  return domCache[id];
};
const clearCache = () => Object.keys(domCache).forEach(k => delete domCache[k]);

// âœ… ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡: regex patterns Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹
const REGEX_PATTERNS = {
  nonDigit: /\D/g,
  phoneDigits: /[^\d\s]/g,
  spaces: /\s/g,
  leadingQuote: /^'/,
  dateISO: /^(\d{4})-(\d{2})-(\d{2})/,
  dateDDMMYYYY: /^\d{2}-\d{2}-\d{4}$/,
  htmlEscape: /[&<>"'`=\/]/g
};

function buildLoanFormTemplate({ title, personData, buttonText }) {
  const formattedBirthDate = formatToDayMonthYear(personData.birthDate || '');
  return `
    <h2 style="margin-bottom:12px;">${title}</h2>

    <!-- Ø§Ù„ØµÙ 1: Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ ÙˆØ§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ -->
    <div class="row">
      <div class="col">
        <label for="empIdField">Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ</label>
        <input type="text" id="empIdField" value="${escapeHtml(personData.empId || '')}" readonly>
      </div>
      <div class="col">
        <label for="nameField">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
        <input type="text" id="nameField" value="${escapeHtml(personData.name || '')}" readonly>
      </div>
    </div>

    <!-- Ø§Ù„ØµÙ 2: ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ ÙˆØ§Ù„Ø±ØªØ¨Ø© -->
    <div class="row">
      <div class="col">
        <label for="birthDateField">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label>
        <input type="text" id="birthDateField" value="${escapeHtml(formattedBirthDate)}" readonly>
      </div>
      <div class="col">
        <label for="gradeField">Ø§Ù„Ø±ØªØ¨Ø©</label>
        <input type="text" id="gradeField" value="${escapeHtml(personData.grade || '')}" readonly>
      </div>
    </div>

    <!-- Ø§Ù„ØµÙ 3: Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„ ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ -->
    <div class="row">
      <div class="col">
        <label for="placeField">Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„</label>
        <input type="text" id="placeField" value="${escapeHtml(personData.place || '')}" readonly>
      </div>
      <div class="col">
        <label for="personalPhoneField">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
        <input type="text" id="personalPhoneField" value="${escapeHtml(personData.personalPhone || '')}" placeholder="00 00 00 00 00" oninput="formatPhoneSimple(this)" dir="ltr">
      </div>
    </div>

    <!-- Ø§Ù„ØµÙ 4: Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© ÙˆØ§Ù„Ø¨Ù„Ø¯ÙŠØ© -->
    <div class="row">
      <div class="col">
        <label for="daairaField">Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©</label>
        <select id="daairaField">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©</option>
          <option value="ØªÙˆÙ‚Ø±Øª">ØªÙˆÙ‚Ø±Øª</option>
          <option value="ØªÙ…Ø§Ø³ÙŠÙ†">ØªÙ…Ø§Ø³ÙŠÙ†</option>
          <option value="Ø§Ù„Ù…Ù‚Ø§Ø±ÙŠÙ†">Ø§Ù„Ù…Ù‚Ø§Ø±ÙŠÙ†</option>
          <option value="Ø§Ù„Ø­Ø¬ÙŠØ±Ø©">Ø§Ù„Ø­Ø¬ÙŠØ±Ø©</option>
          <option value="Ø§Ù„Ø·ÙŠØ¨Ø§Øª">Ø§Ù„Ø·ÙŠØ¨Ø§Øª</option>
        </select>
      </div>
      <div class="col">
        <label for="baladiyaField">Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©</label>
        <select id="baladiyaField">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©</option>
        </select>
      </div>
    </div>

    <!-- Ø§Ù„ØµÙ 5: Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„ÙŠØ© ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆÙ„Ø§Ø¯ -->
    <div class="row">
      <div class="col">
        <label for="maritalStatusField">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„ÙŠØ©</label>
        <select id="maritalStatusField">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©</option>
          <option value="Ø£Ø¹Ø²Ø¨(Ø©)">Ø£Ø¹Ø²Ø¨(Ø©)</option>
          <option value="Ù…ØªØ²ÙˆØ¬(Ø©)">Ù…ØªØ²ÙˆØ¬(Ø©)</option>
          <option value="Ù…Ø·Ù„Ù‚(Ø©)">Ù…Ø·Ù„Ù‚(Ø©)</option>
        </select>
      </div>
      <div class="col" id="childrenCountWrapper" style="display:none;">
        <label for="childrenCountField">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆÙ„Ø§Ø¯</label>
        <input type="number" id="childrenCountField" min="0" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ø¯Ø¯">
      </div>
    </div>

    <!-- Ø§Ù„ØµÙ 6: Ø«Ù†Ø§Ø¦ÙŠ Ø§Ù„Ù‚Ø·Ø§Ø¹ -->
    <div class="row">
      <div class="col" id="dualSectorWrapper" style="display:none;">
        <label for="dualSectorField">Ø«Ù†Ø§Ø¦ÙŠ Ø§Ù„Ù‚Ø·Ø§Ø¹</label>
        <select id="dualSectorField">
          <option value="">Ø§Ø®ØªØ± Ø®ÙŠØ§Ø±Ù‹Ø§</option>
          <option value="Ù„Ø§">Ù„Ø§</option>
          <option value="Ù†Ø¹Ù…">Ù†Ø¹Ù…</option>
        </select>
      </div>
      <div class="col" id="spouseStatusWrapper" style="display:none;">
        <label for="spouseStatusField">ØµÙØ© Ø§Ù„Ø²ÙˆØ¬(Ø©)</label>
        <select id="spouseStatusField">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙØ©</option>
          <option value="Ù…ÙˆØ¸Ù(Ø©)">Ù…ÙˆØ¸Ù(Ø©)</option>
          <option value="Ù…ØªÙ‚Ø§Ø¹Ø¯(Ø©)">Ù…ØªÙ‚Ø§Ø¹Ø¯(Ø©)</option>
        </select>
      </div>
    </div>

    <!-- Ø§Ù„ØµÙ 7: Ø±Ù‚Ù… ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø²ÙˆØ¬(Ø©) - ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ¸Ù(Ø©) -->
    <div class="row" id="spouseIdWrapper" style="display:none;">
      <div class="col">
        <label for="spouseIdField">Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ù„Ù„Ø²ÙˆØ¬(Ø©)</label>
        <input type="text" id="spouseIdField" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ (16 Ø±Ù‚Ù…Ù‹Ø§)" oninput="validateNumber(this)">
      </div>
    </div>

    <div class="small-note" id="spouseStatusMessage" style="display:none;"></div>

    <!-- Ø§Ù„ØµÙ 8: Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø²ÙˆØ¬(Ø©) - ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…ØªÙ‚Ø§Ø¹Ø¯(Ø©) Ø£Ùˆ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ -->
    <div class="row" id="spouseNameWrapper" style="display:none;">
      <div class="col">
        <label for="spouseNameField">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø²ÙˆØ¬(Ø©)</label>
        <input type="text" id="spouseNameField" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
      </div>
    </div>

    <!-- Ø§Ù„ØµÙ 9: Ø§Ù„ÙƒÙØ§Ù„Ø© ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ø£ÙØ±Ø§Ø¯ Ø§Ù„Ù…ÙƒÙÙˆÙ„ÙŠÙ† -->
    <div class="row">
      <div class="col" id="guaranteeWrapper">
        <label for="guaranteeField">Ø§Ù„ÙƒÙØ§Ù„Ø©</label>
        <select id="guaranteeField">
          <option value="">Ø§Ø®ØªØ± Ø®ÙŠØ§Ø±Ù‹Ø§</option>
          <option value="Ù„Ø§">Ù„Ø§</option>
          <option value="Ù†Ø¹Ù…">Ù†Ø¹Ù…</option>
        </select>
      </div>
      <div class="col" id="guaranteedCountWrapper" style="display:none;">
        <label for="guaranteedCountField">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙØ±Ø§Ø¯ Ø§Ù„Ù…ÙƒÙÙˆÙ„ÙŠÙ†</label>
        <input type="number" id="guaranteedCountField" min="0" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ø¯Ø¯">
      </div>
    </div>

    <!-- Ø§Ù„ØµÙ 10: Ø§Ù„ÙˆØ¬Ù‡Ø© ÙˆØ§Ù„ÙÙˆØ¬ -->
    <div class="row">
      <div class="col">
        <label for="destinationField">Ø§Ù„ÙˆØ¬Ù‡Ø©</label>
        <select id="destinationField">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ¬Ù‡Ø©</option>
          <option value="ÙˆÙ‡Ø±Ø§Ù†">ÙˆÙ‡Ø±Ø§Ù†</option>
          <option value="Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±">Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±</option>
          <option value="Ø¹Ù†Ø§Ø¨Ø©">Ø¹Ù†Ø§Ø¨Ø©</option>
        </select>
      </div>
      <div class="col">
        <label for="cohortField">Ø§Ù„ÙÙˆØ¬</label>
        <select id="cohortField">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙÙˆØ¬</option>
        </select>
      </div>
    </div>

    <div class="small-note">ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</div>
    <button id="submitBtn" onclick="submitForm()">${buttonText}</button>
  `;
}

function showForm(empId, data) {
  isEditMode = false;
  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø¹Ù†Ø¯ ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
  originalRegistrationDate = null;
  originalModificationDate = null;
  currentModificationDate = null;
  clearCache(); // Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´ Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø¬Ø¯ÙŠØ¯
  const container = getEl("mainContainer");
  container.innerHTML = buildLoanFormTemplate({
    title: "Ø§Ø³ØªÙ…Ø§Ø±Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ø®ÙŠÙ…Ø§Øª",
    personData: {
      empId,
      name: data.name || '',
      birthDate: data.diz || '',
      grade: data.grade || '',
      place: data.place || '',
      personalPhone: ''
    },
    buttonText: "ØªØ³Ø¬ÙŠÙ„"
  });

  initializeForm();
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙˆØ¬ Ø­Ø³Ø¨ Ø§Ù„ÙˆØ¬Ù‡Ø©
function updateCohort() {
  const destinationField = getEl("destinationField");
  const cohortField = getEl("cohortField");
  
  if (!destinationField || !cohortField) return;
  
  const destination = destinationField.value;
  cohortField.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙÙˆØ¬</option>';
  
  if (destination === "ÙˆÙ‡Ø±Ø§Ù†") {
    cohortField.innerHTML += '<option value="Ø§Ù„ÙÙˆØ¬ 1">Ø§Ù„ÙÙˆØ¬ 1</option>';
    cohortField.innerHTML += '<option value="Ø§Ù„ÙÙˆØ¬ 2">Ø§Ù„ÙÙˆØ¬ 2</option>';
  } else if (destination === "Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±") {
    cohortField.innerHTML += '<option value="Ø§Ù„ÙÙˆØ¬ 3">Ø§Ù„ÙÙˆØ¬ 3</option>';
    cohortField.innerHTML += '<option value="Ø§Ù„ÙÙˆØ¬ 4">Ø§Ù„ÙÙˆØ¬ 4</option>';
  } else if (destination === "Ø¹Ù†Ø§Ø¨Ø©") {
    cohortField.innerHTML += '<option value="Ø§Ù„ÙÙˆØ¬ 5">Ø§Ù„ÙÙˆØ¬ 5</option>';
    cohortField.innerHTML += '<option value="Ø§Ù„ÙÙˆØ¬ 6">Ø§Ù„ÙÙˆØ¬ 6</option>';
  }
}

// Ø¯Ø§Ù„Ø© Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©
function initializeForm() {
  clearCache(); // Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´ Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
  const daairaField = getEl("daairaField");
  if (daairaField) {
    daairaField.addEventListener("change", () => updateBaladiya());
  }

  const maritalField = getEl("maritalStatusField");
  if (maritalField) {
    maritalField.addEventListener("change", toggleChildrenField);
  }

  const dualField = getEl("dualSectorField");
  if (dualField) {
    dualField.addEventListener("change", toggleDualSector);
  }

  const spouseStatusField = getEl("spouseStatusField");
  if (spouseStatusField) {
    spouseStatusField.addEventListener("change", toggleSpouseStatus);
  }

  const destinationField = getEl("destinationField");
  if (destinationField) {
    destinationField.addEventListener("change", updateCohort);
  }

  const spouseIdField = getEl("spouseIdField");
  if (spouseIdField) {
    spouseIdField.addEventListener("blur", verifySpouseInFirebase);
    spouseIdField.addEventListener("input", handleSpouseInput);
  }

  const guaranteeField = getEl("guaranteeField");
  if (guaranteeField) {
    guaranteeField.addEventListener("change", toggleGuarantee);
  }

  toggleChildrenField();
  toggleDualSector();
  toggleSpouseStatus();
  toggleGuarantee(false); // false = Ù„Ø§ ØªØ¸Ù‡Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
  updateCohort();
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø© ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
function showEditForm(empId, firebaseData, existingData) {
  isEditMode = true;
  // Ø­ÙØ¸ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£ØµÙ„ÙŠ ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£ØµÙ„ÙŠ
  originalRegistrationDate = existingData.date || null;
  originalModificationDate = existingData.modificationDate || null;
  clearCache(); // Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´ Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ ØªØ¹Ø¯ÙŠÙ„
  const container = getEl("mainContainer");
  container.innerHTML = buildLoanFormTemplate({
    title: "ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ù…Ø®ÙŠÙ…Ø§Øª",
    personData: {
      empId,
      name: firebaseData.name || '',
      birthDate: firebaseData.diz || '',
      grade: firebaseData.grade || '',
      place: firebaseData.place || '',
      personalPhone: existingData.personalPhone ? formatPhoneNumber(existingData.personalPhone) : ''
    },
    buttonText: "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª"
  });

  initializeForm();

  // âœ… ØªØ­Ø³ÙŠÙ†: Ø§Ø³ØªØ®Ø¯Ø§Ù… requestAnimationFrame Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† setTimeout
  requestAnimationFrame(() => {
    const daairaField = getEl("daairaField");
    if (daairaField) {
      daairaField.value = existingData.daira || "";
      updateBaladiya(existingData.baladiya || "");
    }

    const baladiyaField = getEl("baladiyaField");
    if (baladiyaField) {
      baladiyaField.value = existingData.baladiya || "";
    }

    const maritalField = getEl("maritalStatusField");
    if (maritalField) {
      maritalField.value = existingData.maritalStatus || "";
      toggleChildrenField();
    }

    const childrenField = getEl("childrenCountField");
    if (childrenField) {
      const rawChildrenCount = existingData.childrenCount;
      const normalizedChildrenCount =
        rawChildrenCount === undefined || rawChildrenCount === null
          ? ""
          : String(rawChildrenCount).trim();

      if (normalizedChildrenCount !== "") {
        childrenField.value = normalizedChildrenCount;
      } else if (["Ù…ØªØ²ÙˆØ¬(Ø©)", "Ù…Ø·Ù„Ù‚(Ø©)"].includes(existingData.maritalStatus || "")) {
        childrenField.value = "0";
      }
    }

    const dualField = getEl("dualSectorField");
    if (dualField) {
      dualField.value = existingData.dualSector || "";
      toggleDualSector();
    }

    const spouseStatusField = getEl("spouseStatusField");
    if (spouseStatusField && existingData.spouseStatus) {
      spouseStatusField.value = existingData.spouseStatus;
      toggleSpouseStatus();
    }

    if (existingData.spouseEmpId) {
      const spouseIdField = getEl("spouseIdField");
      if (spouseIdField) {
        spouseIdField.value = existingData.spouseEmpId;
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙØ© Ù…ÙˆØ¸Ù(Ø©)ØŒ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Firebase
        if (spouseStatusField && spouseStatusField.value === "Ù…ÙˆØ¸Ù(Ø©)") {
          verifySpouseInFirebase();
        }
      }
    }

    if (existingData.spouseName) {
      const spouseNameField = getEl("spouseNameField");
      const spouseNameWrapper = getEl("spouseNameWrapper");
      if (spouseNameField && spouseNameWrapper) {
        spouseNameField.value = existingData.spouseName;
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙØ© Ù…ØªÙ‚Ø§Ø¹Ø¯(Ø©)ØŒ Ø¬Ø¹Ù„ Ø§Ù„Ø­Ù‚Ù„ Ù‚Ø§Ø¨Ù„Ø§Ù‹ Ù„Ù„ØªØ­Ø±ÙŠØ±
        if (spouseStatusField && spouseStatusField.value === "Ù…ØªÙ‚Ø§Ø¹Ø¯(Ø©)") {
          spouseNameField.readOnly = false;
          // Ø¥Ø¶Ø§ÙØ© event listeners Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙ‚Ø· (ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„)
          if (spouseNameField.dataset.arabicListener !== "true") {
            spouseNameField.addEventListener("input", function() { 
              allowArabicOnly(this); 
            });
            spouseNameField.addEventListener("paste", function(e) {
              e.preventDefault();
              const paste = (e.clipboardData || window.clipboardData).getData("text");
              this.value = paste.replace(/[^\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF\s]/g, '');
            });
            spouseNameField.dataset.arabicListener = "true";
          }
        } else {
          spouseNameField.readOnly = true;
        }
        spouseNameWrapper.style.display = "block";
      }
    }

    const guaranteeField = getEl("guaranteeField");
    if (guaranteeField && existingData.guarantee) {
      guaranteeField.value = existingData.guarantee;
      // Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„ØªØ¬Ù†Ø¨ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
      guaranteeField.dataset.previousValue = existingData.guarantee;
      toggleGuarantee(false); // false = Ù„Ø§ ØªØ¸Ù‡Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    }

    const guaranteedCountField = getEl("guaranteedCountField");
    if (guaranteedCountField && existingData.guaranteedCount) {
      guaranteedCountField.value = existingData.guaranteedCount;
    }

    const destinationField = getEl("destinationField");
    if (destinationField) {
      destinationField.value = existingData.destination || "";
      updateCohort();
    }

    const cohortField = getEl("cohortField");
    if (cohortField && existingData.cohort) {
      cohortField.value = existingData.cohort || "";
    }
  });
}

function handleSpouseInput() {
  const dualField = getEl("dualSectorField");
  const spouseStatusField = getEl("spouseStatusField");
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø«Ù†Ø§Ø¦ÙŠ Ø§Ù„Ù‚Ø·Ø§Ø¹ = Ù†Ø¹Ù… ÙˆØ§Ù„ØµÙØ© = Ù…ÙˆØ¸Ù(Ø©)
  if (!dualField || dualField.value !== "Ù†Ø¹Ù…") return;
  if (!spouseStatusField || spouseStatusField.value !== "Ù…ÙˆØ¸Ù(Ø©)") return;

  const spouseIdField = getEl("spouseIdField");
  const statusMessage = getEl("spouseStatusMessage");
  const spouseNameWrapper = getEl("spouseNameWrapper");
  const spouseNameField = getEl("spouseNameField");

  if (!spouseIdField || !statusMessage) return;

  const value = spouseIdField.value.trim();

  if (spouseNameWrapper) spouseNameWrapper.style.display = "none";
  if (spouseNameField) {
    spouseNameField.value = "";
    spouseNameField.readOnly = true; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† readonly
  }

  if (!value) {
    statusMessage.style.display = "none";
    statusMessage.textContent = "";
    if (spouseLookupTimeout) {
      clearTimeout(spouseLookupTimeout);
      spouseLookupTimeout = null;
    }
    return;
  }

  statusMessage.style.display = "block";
  statusMessage.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø²ÙˆØ¬(Ø©)...";

  if (value.length < 16) {
    if (spouseLookupTimeout) {
      clearTimeout(spouseLookupTimeout);
      spouseLookupTimeout = null;
    }
    return;
  }

  if (spouseLookupTimeout) {
    clearTimeout(spouseLookupTimeout);
  }
  spouseLookupTimeout = setTimeout(() => {
    spouseLookupTimeout = null;
    verifySpouseInFirebase();
  }, 400);
}

function toggleChildrenField() {
  const maritalField = getEl("maritalStatusField");
  const wrapper = getEl("childrenCountWrapper");
  const childrenField = getEl("childrenCountField");
  const dualSectorWrapper = getEl("dualSectorWrapper");
  const dualSectorField = getEl("dualSectorField");
  const spouseIdWrapper = getEl("spouseIdWrapper");
  const spouseIdField = getEl("spouseIdField");
  const spouseNameWrapper = getEl("spouseNameWrapper");
  const spouseNameField = getEl("spouseNameField");
  const statusMessage = getEl("spouseStatusMessage");
  if (!maritalField || !wrapper || !childrenField) return;

  const needsChildren = ["Ù…ØªØ²ÙˆØ¬(Ø©)", "Ù…Ø·Ù„Ù‚(Ø©)"].includes(maritalField.value);
  wrapper.style.display = needsChildren ? "block" : "none";

  if (!needsChildren) {
    childrenField.value = "";
  }

  if (dualSectorWrapper) {
    const showDualSector = ["Ù…ØªØ²ÙˆØ¬(Ø©)", "Ù…Ø·Ù„Ù‚(Ø©)"].includes(maritalField.value);
    dualSectorWrapper.style.display = showDualSector ? "block" : "none";

    if (!showDualSector) {
      if (dualSectorField) dualSectorField.value = "";
      // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„Ø²ÙˆØ¬(Ø©) Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø£Ø¹Ø²Ø¨(Ø©)
      const spouseStatusWrapper = getEl("spouseStatusWrapper");
      const spouseStatusField = getEl("spouseStatusField");
      if (spouseStatusWrapper) spouseStatusWrapper.style.display = "none";
      if (spouseStatusField) spouseStatusField.value = "";
      if (spouseIdWrapper) spouseIdWrapper.style.display = "none";
      if (spouseIdField) spouseIdField.value = "";
      if (spouseNameWrapper) spouseNameWrapper.style.display = "none";
      if (spouseNameField) spouseNameField.value = "";
      if (statusMessage) {
        statusMessage.style.display = "none";
        statusMessage.textContent = "";
      }
      if (spouseLookupTimeout) {
        clearTimeout(spouseLookupTimeout);
        spouseLookupTimeout = null;
      }
    } else {
      // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…ØªØ²ÙˆØ¬(Ø©) Ø£Ùˆ Ù…Ø·Ù„Ù‚(Ø©)ØŒ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø«Ù†Ø§Ø¦ÙŠ Ø§Ù„Ù‚Ø·Ø§Ø¹
      toggleDualSector();
    }
  }
}

function toggleDualSector() {
  const dualField = getEl("dualSectorField");
  const maritalField = getEl("maritalStatusField");
  const spouseStatusWrapper = getEl("spouseStatusWrapper");
  const spouseStatusField = getEl("spouseStatusField");
  const spouseIdWrapper = getEl("spouseIdWrapper");
  const spouseNameWrapper = getEl("spouseNameWrapper");
  const spouseIdField = getEl("spouseIdField");
  const spouseNameField = getEl("spouseNameField");
  const statusMessage = getEl("spouseStatusMessage");

  if (!dualField) return;

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„ÙŠØ© Ù„ÙŠØ³Øª Ø£Ø¹Ø²Ø¨(Ø©)
  const isMarriedOrDivorced = maritalField && ["Ù…ØªØ²ÙˆØ¬(Ø©)", "Ù…Ø·Ù„Ù‚(Ø©)"].includes(maritalField.value);

  if (dualField.value === "Ù†Ø¹Ù…" && isMarriedOrDivorced) {
    // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚Ù„ Ø§Ù„ØµÙØ© ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„ÙŠØ© Ù…ØªØ²ÙˆØ¬(Ø©) Ø£Ùˆ Ù…Ø·Ù„Ù‚(Ø©)
    if (spouseStatusWrapper) spouseStatusWrapper.style.display = "block";
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø®Ø±Ù‰
    if (spouseIdWrapper) spouseIdWrapper.style.display = "none";
    if (spouseNameWrapper) spouseNameWrapper.style.display = "none";
    if (spouseIdField) spouseIdField.value = "";
    if (spouseNameField) spouseNameField.value = "";
    if (statusMessage) {
      statusMessage.style.display = "none";
      statusMessage.textContent = "";
    }
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙØ© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
    if (spouseStatusField) {
      spouseStatusField.value = "";
      toggleSpouseStatus();
    }
  } else {
    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„Ø²ÙˆØ¬(Ø©)
    if (spouseStatusWrapper) spouseStatusWrapper.style.display = "none";
    if (spouseIdWrapper) spouseIdWrapper.style.display = "none";
    if (spouseNameWrapper) spouseNameWrapper.style.display = "none";
    if (spouseStatusField) spouseStatusField.value = "";
    if (spouseIdField) spouseIdField.value = "";
    if (spouseNameField) spouseNameField.value = "";
    if (statusMessage) {
      statusMessage.style.display = "none";
      statusMessage.textContent = "";
    }
    if (spouseLookupTimeout) {
      clearTimeout(spouseLookupTimeout);
      spouseLookupTimeout = null;
    }
  }
}

function toggleSpouseStatus() {
  const spouseStatusField = getEl("spouseStatusField");
  const spouseIdWrapper = getEl("spouseIdWrapper");
  const spouseNameWrapper = getEl("spouseNameWrapper");
  const spouseIdField = getEl("spouseIdField");
  const spouseNameField = getEl("spouseNameField");
  const statusMessage = getEl("spouseStatusMessage");

  if (!spouseStatusField) return;

  const status = spouseStatusField.value;

  // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹
  if (spouseIdWrapper) spouseIdWrapper.style.display = "none";
  if (spouseNameWrapper) spouseNameWrapper.style.display = "none";
  if (spouseIdField) spouseIdField.value = "";
  if (spouseNameField) spouseNameField.value = "";
  if (statusMessage) {
    statusMessage.style.display = "none";
    statusMessage.textContent = "";
  }

  if (status === "Ù…ÙˆØ¸Ù(Ø©)") {
    // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚Ù„ Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ
    if (spouseIdWrapper) spouseIdWrapper.style.display = "block";
    // Ø¬Ø¹Ù„ Ø­Ù‚Ù„ Ø§Ù„Ø§Ø³Ù… readonly (Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Firebase)
    if (spouseNameField) {
      spouseNameField.readOnly = true;
      // Ø¥Ø²Ø§Ù„Ø© event listeners Ù„Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ¸Ù
      if (spouseNameField.dataset.arabicListener === "true") {
        const currentValue = spouseNameField.value;
        const newField = spouseNameField.cloneNode(true);
        newField.value = currentValue; // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø©
        spouseNameField.parentNode.replaceChild(newField, spouseNameField);
        clearCache(); // Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´ Ø¨Ø¹Ø¯ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¹Ù†ØµØ±
      }
    }
  } else if (status === "Ù…ØªÙ‚Ø§Ø¹Ø¯(Ø©)") {
    // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ ÙŠØ¯ÙˆÙŠØ§Ù‹
    if (spouseNameWrapper) spouseNameWrapper.style.display = "block";
    // Ø¬Ø¹Ù„ Ø­Ù‚Ù„ Ø§Ù„Ø§Ø³Ù… Ù‚Ø§Ø¨Ù„Ø§Ù‹ Ù„Ù„ØªØ­Ø±ÙŠØ±
    if (spouseNameField) {
      spouseNameField.readOnly = false;
      // Ø¥Ø¶Ø§ÙØ© event listeners Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙ‚Ø· (ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„)
      if (spouseNameField.dataset.arabicListener !== "true") {
        spouseNameField.addEventListener("input", function() { 
          allowArabicOnly(this); 
        });
        spouseNameField.addEventListener("paste", function(e) {
          e.preventDefault();
          const paste = (e.clipboardData || window.clipboardData).getData("text");
          this.value = paste.replace(/[^\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF\s]/g, '');
        });
        spouseNameField.dataset.arabicListener = "true";
      }
    }
  }

  if (spouseLookupTimeout) {
    clearTimeout(spouseLookupTimeout);
    spouseLookupTimeout = null;
  }
}


async function verifySpouseInFirebase() {
  const dualField = getEl("dualSectorField");
  const spouseStatusField = getEl("spouseStatusField");
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø«Ù†Ø§Ø¦ÙŠ Ø§Ù„Ù‚Ø·Ø§Ø¹ = Ù†Ø¹Ù… ÙˆØ§Ù„ØµÙØ© = Ù…ÙˆØ¸Ù(Ø©)
  if (!dualField || dualField.value !== "Ù†Ø¹Ù…") return;
  if (!spouseStatusField || spouseStatusField.value !== "Ù…ÙˆØ¸Ù(Ø©)") return;

  const spouseIdField = getEl("spouseIdField");
  const statusMessage = getEl("spouseStatusMessage");
  const spouseNameWrapper = getEl("spouseNameWrapper");
  const spouseNameField = getEl("spouseNameField");

  if (!spouseIdField || !statusMessage || !spouseNameWrapper || !spouseNameField) return;

  const spouseId = spouseIdField.value.trim();

  spouseNameField.value = "";
  statusMessage.style.display = "none";
  statusMessage.textContent = "";

  if (!spouseId) return;

  if (spouseId.length !== 16) {
    statusMessage.style.display = "block";
    statusMessage.textContent = "ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙƒÙˆÙ† Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ Ù…Ù† 16 Ø±Ù‚Ù…Ù‹Ø§.";
    return;
  }

  statusMessage.style.display = "block";
  statusMessage.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù‚Ù…...";

  try {
    let spouseData = null;
    const docRef = db.collection("employeescom").doc(spouseId);
    const docSnap = await docRef.get();

    if (docSnap.exists) {
      spouseData = docSnap.data();
      } else {
      const querySnap = await db.collection("employeescom")
        .where("empId", "==", spouseId)
        .limit(1)
        .get();
      if (!querySnap.empty) {
        spouseData = querySnap.docs[0].data();
      }
    }

    if (!spouseData) {
      statusMessage.textContent = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.";
      return;
    }

    spouseNameField.value = spouseData.name || "";
    spouseNameField.readOnly = true; // Ø¬Ø¹Ù„Ù‡ readonly Ø¨Ø¹Ø¯ Ù…Ù„Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    spouseNameWrapper.style.display = "block";
    statusMessage.textContent = "ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­.";
  } catch (error) {
    console.error("Spouse verification error:", error);
    statusMessage.textContent = "ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.";
  }
}

function toggleGuarantee(showWarning = true) {
  const guaranteeField = getEl("guaranteeField");
  const wrapper = getEl("guaranteedCountWrapper");
  const guaranteedCountField = getEl("guaranteedCountField");

  if (!guaranteeField || !wrapper || !guaranteedCountField) return;

  const hasGuarantee = guaranteeField.value === "Ù†Ø¹Ù…";
  const previousValue = guaranteeField.dataset.previousValue || "";

  // Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙƒÙ‚ÙŠÙ…Ø© Ø³Ø§Ø¨Ù‚Ø©
  guaranteeField.dataset.previousValue = guaranteeField.value;

  if (hasGuarantee) {
    wrapper.style.display = "block";
  } else {
    wrapper.style.display = "none";
    guaranteedCountField.value = "";
  }

  // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙŠÙŠØ± Ù…Ù† "Ù„Ø§" Ø£Ùˆ "" Ø¥Ù„Ù‰ "Ù†Ø¹Ù…"
  if (hasGuarantee && showWarning && previousValue !== "Ù†Ø¹Ù…") {
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… setTimeout Ù„ØªØ£Ø®ÙŠØ± Ø¸Ù‡ÙˆØ± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    setTimeout(() => {
      Swal.fire({
        icon: "info",
        title: '<div style="font-size: 20px; font-weight: 700; color: #1a237e; margin-bottom: 8px;">ğŸ”” ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ù…</div>',
        html: `
          <div style="text-align: right; direction: rtl; font-family: 'Cairo', sans-serif; padding: 5px 0;">
            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #f5f5f5 100%); padding: 15px; border-radius: 10px; margin-bottom: 12px; border-right: 4px solid #2196f3;">
              <p style="font-size: 14px; line-height: 1.8; margin: 0; color: #1565c0; font-weight: 500;">
                <span style="font-size: 18px; margin-left: 6px;">ğŸ“‹</span>
                Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø±ÙƒÙ… Ø®ÙŠØ§Ø± Ø§Ù„ÙƒÙØ§Ù„Ø©ØŒ ÙŠØªÙˆØ¬Ù‘Ø¨ Ø¹Ù„ÙŠÙƒÙ… Ø§Ù„Ø¥Ø¯Ù„Ø§Ø¡ Ø¨ÙˆØ«ÙŠÙ‚Ø© Ø±Ø³Ù…ÙŠØ© ØªØ«Ø¨Øª ØµØ­Ø© ÙƒÙØ§Ù„Ø© Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø§Ù„Ù…ØµØ±Ù‘Ø­ Ø¨Ù‡Ù….
              </p>
            </div>
            
            <div style="background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%); padding: 15px; border-radius: 10px; border-right: 4px solid #f44336;">
              <p style="font-size: 14px; line-height: 1.8; margin: 0; color: #c62828; font-weight: 600;">
                <span style="font-size: 18px; margin-left: 6px;">âš ï¸</span>
                ÙˆÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©ØŒ Ù„Ù† ØªÙØ¹ØªÙ…Ø¯ Ø§Ù„ÙƒÙØ§Ù„Ø©ØŒ ÙƒÙ…Ø§ Ù„Ù† ÙŠÙØ³Ù…Ø­ Ø¨Ù…Ø±Ø§ÙÙ‚Ø© Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø§Ù„Ù…Ø¹Ù†ÙŠÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø®ÙŠÙ… ÙÙŠ Ø­Ø§Ù„ Ù†Ø¬Ø§Ø­ÙƒÙ… ÙÙŠ Ø§Ù„Ù‚Ø±Ø¹Ø©.
              </p>
            </div>
          </div>
        `,
        confirmButtonText: '<span style="font-size: 15px; font-weight: 600;">ÙÙ‡Ù…Øª</span>',
        confirmButtonColor: "#2575fc",
        width: "520px",
        padding: "1.5rem",
        customClass: {
          popup: 'swal2-popup-custom',
          title: 'swal2-title-custom'
        }
      });
    }, 100);
  }
}

function updateBaladiya(selectedBaladiya = "") {
  const daairaField = getEl("daairaField");
  const baladiyaSelect = getEl("baladiyaField");

  if (!daairaField || !baladiyaSelect) return;

  const daaira = daairaField.value;
  baladiyaSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©</option>';

  if (daaira && window.baladiyaMap[daaira]) {
    window.baladiyaMap[daaira].forEach(b => {
      const option = document.createElement("option");
      option.value = b;
      option.text = b;
      baladiyaSelect.add(option);
    });
  }

  if (selectedBaladiya) {
    baladiyaSelect.value = selectedBaladiya;
  }
}

/* Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙ‚Ø· */
function allowArabicOnly(input) {
  // Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ù…Ø³Ø§ÙØ§Øª
  let value = input.value.replace(/[^\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF\s]/g, '');
  input.value = value;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¹Ù„Ù‰ Ø´ÙƒÙ„ 00 00 00 00 00 */
function formatPhoneSimple(input) {
  // Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
  let value = input.value.replace(REGEX_PATTERNS.nonDigit, '');
  
  // ØªØ­Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ 10 Ø£Ø±Ù‚Ø§Ù…
  value = value.slice(0, 10);
  
  // âœ… ØªØ­Ø³ÙŠÙ†: ØªÙ†Ø³ÙŠÙ‚ Ø£Ø³Ø±Ø¹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… slice
  if (value.length > 0) {
    const parts = [];
    for (let i = 0; i < value.length; i += 2) {
      parts.push(value.slice(i, i + 2));
    }
    input.value = parts.join(' ');
  } else {
    input.value = '';
  }
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø«Ø§Ø¨Øª Ø¹Ù„Ù‰ Ø´ÙƒÙ„ 000 00 00 00 (9 Ø£Ø±Ù‚Ø§Ù…) */
function formatFixedPhone(input) {
  // Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
  let value = input.value.replace(REGEX_PATTERNS.nonDigit, '');
  
  // ØªØ­Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ 9 Ø£Ø±Ù‚Ø§Ù…
  value = value.slice(0, 9);
  
  // âœ… ØªØ­Ø³ÙŠÙ†: ØªÙ†Ø³ÙŠÙ‚ Ø£Ø³Ø±Ø¹
  if (value.length > 0) {
    const parts = [];
    if (value.length >= 3) {
      parts.push(value.slice(0, 3));
      if (value.length > 3) {
        parts.push(value.slice(3, 5));
        if (value.length > 5) {
          parts.push(value.slice(5, 7));
          if (value.length > 7) {
            parts.push(value.slice(7, 9));
          }
        }
      }
      input.value = parts.join(' ');
    } else {
      input.value = value;
    }
  } else {
    input.value = '';
  }
}

/* Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ù† Ø±Ù‚Ù… Ø¹Ø§Ø¯ÙŠ Ø¥Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚ 00 00 00 00 00 */
function formatPhoneNumber(phone) {
  if (!phone) return '';
  // Ø¥Ø²Ø§Ù„Ø© Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø¥Ù† ÙˆØ¬Ø¯Øª (Ù…Ù† Google Sheets)
  let phoneStr = String(phone).replace(REGEX_PATTERNS.leadingQuote, '');
  // Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ù…Ø³Ø§ÙØ§Øª
  let value = phoneStr.replace(REGEX_PATTERNS.phoneDigits, '');
  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø«Ù… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚
  value = value.replace(REGEX_PATTERNS.spaces, '');
  // ØªØ­Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ 10 Ø£Ø±Ù‚Ø§Ù…
  value = value.slice(0, 10);
  // âœ… ØªØ­Ø³ÙŠÙ†: ØªÙ†Ø³ÙŠÙ‚ Ø£Ø³Ø±Ø¹
  if (value.length === 10) {
    return `${value.slice(0, 2)} ${value.slice(2, 4)} ${value.slice(4, 6)} ${value.slice(6, 8)} ${value.slice(8, 10)}`;
  } else if (value.length > 0) {
    const parts = [];
    for (let i = 0; i < value.length; i += 2) {
      parts.push(value.slice(i, i + 2));
    }
    return parts.join(' ');
  }
  return '';
}

/* Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø«Ø§Ø¨Øª Ù…Ù† Ø±Ù‚Ù… Ø¹Ø§Ø¯ÙŠ Ø¥Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚ 000 00 00 00 */
function formatFixedPhoneNumber(phone) {
  if (!phone) return '';
  // Ø¥Ø²Ø§Ù„Ø© Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø¥Ù† ÙˆØ¬Ø¯Øª (Ù…Ù† Google Sheets)
  let phoneStr = String(phone).replace(REGEX_PATTERNS.leadingQuote, '');
  // Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ù…Ø³Ø§ÙØ§Øª
  let value = phoneStr.replace(REGEX_PATTERNS.phoneDigits, '');
  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø«Ù… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚
  value = value.replace(REGEX_PATTERNS.spaces, '');
  // ØªØ­Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ 9 Ø£Ø±Ù‚Ø§Ù…
  value = value.slice(0, 9);
  // âœ… ØªØ­Ø³ÙŠÙ†: ØªÙ†Ø³ÙŠÙ‚ Ø£Ø³Ø±Ø¹
  if (value.length === 9) {
    return `${value.slice(0, 3)} ${value.slice(3, 5)} ${value.slice(5, 7)} ${value.slice(7, 9)}`;
  } else if (value.length > 0) {
    const parts = [];
    if (value.length >= 3) {
      parts.push(value.slice(0, 3));
      if (value.length >= 5) {
        parts.push(value.slice(3, 5));
        if (value.length >= 7) {
          parts.push(value.slice(5, 7));
          if (value.length >= 9) {
            parts.push(value.slice(7, 9));
          } else {
            parts.push(value.slice(7));
          }
        } else {
          parts.push(value.slice(5));
        }
      } else {
        parts.push(value.slice(3));
      }
    } else {
      return value;
    }
    return parts.join(' ');
  }
  return '';
}       

function snapshotFormValues() {
  const val = (id) => {
    const el = getEl(id);
    return el ? el.value.trim() : "";
  };

  return {
    empId: val("empIdField"),
    name: val("nameField"),
    birthDate: val("birthDateField"),
    grade: val("gradeField"),
    place: val("placeField"),
    personalPhone: val("personalPhoneField"),
    daira: val("daairaField"),
    baladiya: val("baladiyaField"),
    maritalStatus: val("maritalStatusField"),
    childrenCount: val("childrenCountField"),
    dualSector: val("dualSectorField"),
    spouseEmpId: val("spouseIdField"),
    spouseName: val("spouseNameField"),
    spouseStatus: val("spouseStatusField"),
    guarantee: val("guaranteeField"),
    guaranteedCount: val("guaranteedCountField"),
    destination: val("destinationField"),
    cohort: val("cohortField")
  };
}

function prepareReceiptData(raw = {}, options = {}) {
  const normalize = (value) => {
    if (value === undefined || value === null) return "";
    return String(value).trim();
  };
  const normalizeYears = (value) => {
    if (Array.isArray(value)) {
      return value
        .map(item => normalize(item))
        .filter(Boolean)
        .join(", ");
    }
    return normalize(value);
  };

  const data = {
    empId: normalize(raw.empId || raw.empIdField),
    name: normalize(raw.name || raw.fullName),
    birthDate: normalize(raw.birthDate || raw.diz),
    grade: normalize(raw.grade || raw.rank),
    place: normalize(raw.place || raw.workPlace),
    personalPhone: normalize(raw.personalPhone || raw.phone || raw.managerPhone),
    daira: normalize(raw.daira || raw.daaira || raw.district),
    baladiya: normalize(raw.baladiya || raw.municipality),
    maritalStatus: normalize(raw.maritalStatus),
    childrenCount: normalize(
      raw.childrenCount !== undefined && raw.childrenCount !== null
        ? raw.childrenCount
        : ""
    ),
    dualSector: normalize(raw.dualSector),
    spouseEmpId: normalize(raw.spouseEmpId),
    spouseName: normalize(raw.spouseName),
    spouseStatus: normalize(raw.spouseStatus),
    guarantee: normalize(raw.guarantee),
    guaranteedCount: normalize(raw.guaranteedCount),
    destination: normalize(raw.destination),
    cohort: normalize(raw.cohort)
  };

  data.birthDate = data.birthDate ? formatToDayMonthYear(data.birthDate) : "";
  data.personalPhone = data.personalPhone ? formatPhoneNumber(data.personalPhone) : "";
  data.registrationDate = options.registrationDate || raw.registrationDate || raw.date || new Date().toISOString();
  data.modificationDate = options.modificationDate || raw.modificationDate || "";
  data.actionSource = options.actionSource || "";

  return data;
}

function renderReceiptTemplate(data = {}) {
  const safe = (value) => escapeHtml(value || "-");
  const registrationMoment = formatDateFromISO(data.registrationDate || new Date().toISOString());
  const modificationMoment = data.modificationDate ? formatDateFromISO(data.modificationDate) : "";
  const isFamilyStatusRequiringChildren = ["Ù…ØªØ²ÙˆØ¬(Ø©)", "Ù…Ø·Ù„Ù‚(Ø©)"].includes(data.maritalStatus || "");
  const childrenValue = data.childrenCount !== ""
    ? data.childrenCount
    : (isFamilyStatusRequiringChildren ? "0" : "-");

  const childrenRow = isFamilyStatusRequiringChildren
    ? `
      <tr>
        <td class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆÙ„Ø§Ø¯</td>
        <td>${safe(childrenValue)}</td>
      </tr>
    `
    : "";

  const dualSectorRow = isFamilyStatusRequiringChildren
    ? `
      <tr>
        <td class="label">Ø«Ù†Ø§Ø¦ÙŠ Ø§Ù„Ù‚Ø·Ø§Ø¹</td>
        <td>${safe(data.dualSector || "Ù„Ø§")}</td>
      </tr>
    `
    : "";

  const spouseStatusRow = isFamilyStatusRequiringChildren && data.spouseStatus
    ? `
      <tr>
        <td class="label">ØµÙØ© Ø§Ù„Ø²ÙˆØ¬(Ø©)</td>
        <td>${safe(data.spouseStatus)}</td>
      </tr>
    `
    : "";

  // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø²ÙˆØ¬ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø«Ù†Ø§Ø¦ÙŠ Ø§Ù„Ù‚Ø·Ø§Ø¹ = Ù†Ø¹Ù…
  let spouseRows = "";
  if (data.dualSector === "Ù†Ø¹Ù…") {
    // Ø¹Ø±Ø¶ Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙØ© Ù…ÙˆØ¸Ù(Ø©)
    if (data.spouseStatus === "Ù…ÙˆØ¸Ù(Ø©)" && data.spouseEmpId) {
      spouseRows += `
      <tr>
        <td class="label">Ø±Ù‚Ù… ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø²ÙˆØ¬(Ø©)</td>
        <td>${safe(data.spouseEmpId)}</td>
      </tr>`;
    }
    // Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø²ÙˆØ¬(Ø©) Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    if (data.spouseName) {
      spouseRows += `
      <tr>
        <td class="label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø²ÙˆØ¬(Ø©)</td>
        <td>${safe(data.spouseName)}</td>
      </tr>`;
    }
  }

  const guaranteeRow = data.guarantee
    ? `
      <tr>
        <td class="label">Ø§Ù„ÙƒÙØ§Ù„Ø©</td>
        <td>${safe(data.guarantee)}</td>
      </tr>
      ${data.guarantee === "Ù†Ø¹Ù…" && data.guaranteedCount ? `
      <tr>
        <td class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙØ±Ø§Ø¯ Ø§Ù„Ù…ÙƒÙÙˆÙ„ÙŠÙ†</td>
        <td>${safe(data.guaranteedCount)}</td>
      </tr>
      ` : ""}
    `
    : "";

  const destinationRow = data.destination
    ? `
      <tr>
        <td class="label">Ø§Ù„ÙˆØ¬Ù‡Ø©</td>
        <td>${safe(data.destination)}</td>
      </tr>
    `
    : "";
  
  const cohortRow = data.cohort
    ? `
      <tr>
        <td class="label">Ø§Ù„ÙÙˆØ¬</td>
        <td>${safe(data.cohort)}</td>
      </tr>
    `
    : "";

  const modificationLine = modificationMoment
    ? `<div class="meta-item">Ø¢Ø®Ø± ØªØ¹Ø¯ÙŠÙ„: ${safe(modificationMoment)}</div>`
    : "";

  const actionLine = data.actionSource
    ? `<div class="meta-item">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${safe(data.actionSource)}</div>`
    : "";

  return `
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ÙˆØµÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ - ${receiptBranding.service}</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 25px;
      background: #f2f5fb;
      font-family: 'Cairo', sans-serif;
      color: #1d2752;
    }
    .receipt-card {
      max-width: 820px;
      margin: 0 auto;
      background: #fff;
      border-radius: 18px;
      padding: 32px 36px;
      box-shadow: 0 20px 45px rgba(13, 55, 133, 0.15);
      border: 1px solid #e6ecff;
    }
    .receipt-header {
      display: flex;
      gap: 22px;
      align-items: center;
      border-bottom: 2px solid #eef1ff;
      padding-bottom: 18px;
      margin-bottom: 20px;
    }
    .receipt-logo {
      width: 110px;
      height: 110px;
      object-fit: contain;
    }
    .receipt-title h1 {
      font-size: 20px;
      margin: 6px 0 2px;
      color: #172042;
    }
    .receipt-title h2 {
      font-size: 18px;
      margin: 0;
      color: #4357c8;
    }
    .receipt-title p {
      margin: 2px 0;
      font-size: 14px;
      color: #4d5c84;
    }
    .receipt-subtitle {
      text-align: center;
      font-size: 22px;
      margin-bottom: 15px;
      color: #23326b;
    }
    .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      background: #f5f7ff;
      border: 1px solid #dfe6ff;
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 18px;
    }
    .meta-item {
      flex: 1;
      min-width: 180px;
      font-size: 14px;
      font-weight: 600;
      color: #1e2d58;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      page-break-inside: avoid;
    }
    table td {
      padding: 10px 0;
      border-bottom: 1px dashed #d9def0;
      font-size: 15px;
    }
    table td.label {
      color: #5b6592;
      width: 38%;
      font-weight: 600;
    }
    table tr:last-child td {
      border-bottom: none;
    }
    .print-hint {
      text-align: center;
      margin-top: 25px;
      font-size: 14px;
      color: #4c5a88;
    }
    .print-btn {
      margin-top: 12px;
      background: linear-gradient(45deg, #6a11cb, #2575fc);
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      color: #fff;
      font-size: 15px;
      cursor: pointer;
      font-family: 'Cairo', sans-serif;
    }
    @media print {
      body {
        margin: 0;
        padding: 10px;
        background: #fff;
      }
      .receipt-card {
        max-width: 100%;
        margin: 0;
        padding: 15px 20px;
        box-shadow: none;
        border: none;
        page-break-inside: avoid;
      }
      .receipt-header {
        gap: 15px;
        padding-bottom: 12px;
        margin-bottom: 12px;
      }
      .receipt-logo {
        width: 80px;
        height: 80px;
      }
      .receipt-title h1 {
        font-size: 16px;
        margin: 4px 0 1px;
      }
      .receipt-title h2 {
        font-size: 14px;
      }
      .receipt-title p {
        margin: 1px 0;
        font-size: 11px;
      }
      .receipt-subtitle {
        font-size: 18px;
        margin-bottom: 10px;
      }
      .meta {
        gap: 8px;
        padding: 10px;
        margin-bottom: 12px;
      }
      .meta-item {
        font-size: 12px;
        min-width: 150px;
      }
      table {
        page-break-inside: avoid;
      }
      table tr {
        page-break-inside: avoid;
        page-break-after: auto;
      }
      table td {
        padding: 6px 0;
        font-size: 13px;
      }
      table td.label {
        width: 35%;
      }
      .print-hint {
        display: none;
      }
      .print-btn {
        display: none;
      }
      @page {
        size: A4;
        margin: 0.5cm;
      }
    }
  </style>
</head>
<body>
  <div class="receipt-card">
    <div class="receipt-header">
      <img src="${receiptBranding.logoUrl}" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù„Ø¬Ù†Ø©" class="receipt-logo">
      <div class="receipt-title">
        <p>${receiptBranding.govTitle}</p>
        <p>${receiptBranding.ministry}</p>
        <p>${receiptBranding.directorate}</p>
        <h1>${receiptBranding.committee}</h1>
        <h2>${receiptBranding.service}</h2>
        <p>${receiptBranding.addressLine}</p>
        <p>${receiptBranding.contactLine}</p>
      </div>
    </div>
    <h3 class="receipt-subtitle">ÙˆØµÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ø®ÙŠÙ…Ø§Øª</h3>
    <div class="meta">
      <div class="meta-item">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ${safe(registrationMoment)}</div>
      ${modificationLine}
      
    </div>
    <table>
      <tbody>
        <tr>
          <td class="label">Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ</td>
          <td>${safe(data.empId)}</td>
        </tr>
        <tr>
          <td class="label">Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù„Ù‚Ø¨</td>
          <td>${safe(data.name)}</td>
        </tr>
        <tr>
          <td class="label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</td>
          <td>${safe(data.birthDate)}</td>
        </tr>
        <tr>
          <td class="label">Ø§Ù„Ø±ØªØ¨Ø©</td>
          <td>${safe(data.grade)}</td>
        </tr>
        <tr>
          <td class="label">Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„</td>
          <td>${safe(data.place)}</td>
        </tr>
        <tr>
          <td class="label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</td>
          <td style="direction:ltr;unicode-bidi:bidi-override;text-align:right;">${safe(data.personalPhone)}</td>
        </tr>
        <tr>
          <td class="label">Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©</td>
          <td>${safe(data.daira)}</td>
        </tr>
        <tr>
          <td class="label">Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©</td>
          <td>${safe(data.baladiya)}</td>
        </tr>
        <tr>
          <td class="label">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„ÙŠØ©</td>
          <td>${safe(data.maritalStatus || "-")}</td>
        </tr>
        ${childrenRow}
        ${dualSectorRow}
        ${spouseStatusRow}
        ${spouseRows}
        ${guaranteeRow}
        ${destinationRow}
        ${cohortRow}
      </tbody>
    </table>
    <div class="print-hint">
      ÙŠÙ…ÙƒÙ† Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙˆØµÙ„ Ø£Ùˆ Ø­ÙØ¸Ù‡ Ø¨ØµÙŠØºØ© PDF Ø¹Ø¨Ø± Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„.
      <br>
      <button class="print-btn" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙˆØµÙ„</button>
    </div>
  </div>
</body>
</html>
`;
}

function openReceiptPreview(rawData = {}, options = {}) {
  const normalized = prepareReceiptData(rawData, options);
  const receiptHTML = renderReceiptTemplate(normalized);
  const receiptWindow = window.open("", "_blank");

  if (!receiptWindow) {
    Swal.fire("ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ÙØªØ­ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØµÙ„", "warning");
    return;
  }

  receiptWindow.document.open();
  receiptWindow.document.write(receiptHTML);
  receiptWindow.document.close();
  receiptWindow.focus();
}

function attachReceiptButton(buttonId, rawData = {}, options = {}) {
  const btn = getEl(buttonId);
  if (!btn) return;

  btn.addEventListener("click", (event) => {
    event.preventDefault();
    openReceiptPreview(rawData, options);
  });
}



/* ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ */
function validateEmail(email) {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(String(email).toLowerCase());
}

// âœ… ØªØ­Ø³ÙŠÙ†: regex Ù…Ø­ÙÙˆØ¸ Ù…Ø³Ø¨Ù‚Ø§Ù‹
const REGEX_ARABIC = /[\u0600-\u06FF]/g;
function validateGmail(input) {
  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª
  input.value = input.value.replace(REGEX_PATTERNS.spaces, '');
  
  // Ù…Ù†Ø¹ Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
  input.value = input.value.replace(REGEX_ARABIC, '');
  
  // Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ù†Øµ Ø¹Ù„Ù‰ Ø­Ø±ÙˆÙ ØµØºÙŠØ±Ø©
  input.value = input.value.toLowerCase();
  
  // Ø§Ù„Ø³Ù…Ø§Ø­ ÙÙ‚Ø· Ø¨Ù€ gmail
  if (!input.value.endsWith("@gmail.com") && input.value.length > 0) {
    input.setCustomValidity("ÙŠÙØ³Ù…Ø­ ÙÙ‚Ø· Ø¨Ø­Ø³Ø§Ø¨Ø§Øª gmail");
  } else {
    input.setCustomValidity("");
  }
}


async function submitForm() {
  const submitBtn = getEl("submitBtn");
  submitBtn.disabled = true;
  submitBtn.style.opacity = 0.6;

  // âœ… Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„
  Swal.fire({ title: isEditMode ? 'Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª...' : 'Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

  // âœ… ØªØ­Ø³ÙŠÙ†: Ø¬Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙŠÙ… Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©
  const empId = getEl("empIdField").value.trim();
  const name = getEl("nameField").value.trim();
  const grade = getEl("gradeField").value.trim();
  const place = getEl("placeField").value.trim();
  const birthDate = getEl("birthDateField").value.trim();
  const personalPhone = getEl("personalPhoneField").value.trim();
  const daaira = getEl("daairaField").value.trim();
  const baladiya = getEl("baladiyaField").value.trim();
  const maritalStatus = getEl("maritalStatusField").value.trim();
  const childrenCount = getEl("childrenCountField")?.value.trim() ?? "";
  const dualSector = getEl("dualSectorField").value.trim();
  const spouseId = getEl("spouseIdField")?.value.trim() || "";
  const spouseName = getEl("spouseNameField")?.value.trim() || "";
  const spouseStatus = getEl("spouseStatusField")?.value.trim() || "";
  const guarantee = getEl("guaranteeField").value.trim();
  const guaranteedCount = getEl("guaranteedCountField")?.value.trim() ?? "";
  const destination = getEl("destinationField").value.trim();
  const cohort = getEl("cohortField").value.trim();

  const requiredFields = [
    { id: "daairaField", value: daaira },
    { id: "baladiyaField", value: baladiya },
    { id: "maritalStatusField", value: maritalStatus },
    { id: "personalPhoneField", value: personalPhone },
    { id: "guaranteeField", value: guarantee },
    { id: "destinationField", value: destination },
    { id: "cohortField", value: cohort },
  ];

  const isMarriedOrDivorced = ["Ù…ØªØ²ÙˆØ¬(Ø©)", "Ù…Ø·Ù„Ù‚(Ø©)"].includes(maritalStatus);
  if (isMarriedOrDivorced) {
    requiredFields.push(
      { id: "dualSectorField", value: dualSector },
      { id: "childrenCountField", value: childrenCount }
    );
  }

  if (guarantee === "Ù†Ø¹Ù…") {
    requiredFields.push(
      { id: "guaranteedCountField", value: guaranteedCount }
    );
  }

  if (dualSector === "Ù†Ø¹Ù…") {
    requiredFields.push(
      { id: "spouseStatusField", value: spouseStatus }
    );
    if (spouseStatus === "Ù…ÙˆØ¸Ù(Ø©)") {
      requiredFields.push(
        { id: "spouseIdField", value: spouseId }
      );
    }
    if (spouseStatus === "Ù…ØªÙ‚Ø§Ø¹Ø¯(Ø©)") {
      requiredFields.push(
        { id: "spouseNameField", value: spouseName }
      );
    }
  }

  let missing = false;
  requiredFields.forEach(f => {
    const el = getEl(f.id);
    const isEmpty = f.value === "" || f.value === undefined || f.value === null;
    if (el && isEmpty) {
      el.style.border = "2px solid red";
      missing = true;
      setTimeout(() => el.style.border = "", 3000); // Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†Ù ÙŠØ¹ÙˆØ¯ Ù„Ø·Ø¨ÙŠØ¹ØªÙ‡
    }
  });

  if (missing) {
    Swal.close();
    await new Promise(resolve => setTimeout(resolve, 100));
    Swal.fire({
      icon: "warning",
      title: "ØªÙ†Ø¨ÙŠÙ‡",
      text: "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„",
      confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
      allowOutsideClick: true,
      allowEscapeKey: true
    });
    submitBtn.disabled = false;
    submitBtn.style.opacity = 1;
    return;
  }

  const personalPhoneDigits = personalPhone.replace(REGEX_PATTERNS.spaces, '');
  if (personalPhoneDigits.length !== 10) {
    Swal.close();
    await new Promise(resolve => setTimeout(resolve, 100));
    Swal.fire({
      icon: "warning",
      title: "ØªÙ†Ø¨ÙŠÙ‡",
      text: "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 10 Ø£Ø±Ù‚Ø§Ù…",
      confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
      allowOutsideClick: true,
      allowEscapeKey: true
    });
    submitBtn.disabled = false;
    submitBtn.style.opacity = 1;
    return;
  }

  if (dualSector === "Ù†Ø¹Ù…") {
    if (!spouseStatus) {
      Swal.close();
      await new Promise(resolve => setTimeout(resolve, 100));
      Swal.fire({
        icon: "warning",
        title: "ØªÙ†Ø¨ÙŠÙ‡",
        text: "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙØ© Ø§Ù„Ø²ÙˆØ¬(Ø©)",
        confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
        allowOutsideClick: true,
        allowEscapeKey: true
      });
      submitBtn.disabled = false;
      submitBtn.style.opacity = 1;
      return;
    }

    if (spouseStatus === "Ù…ÙˆØ¸Ù(Ø©)") {
      if (spouseId.length !== 16) {
        Swal.close();
        await new Promise(resolve => setTimeout(resolve, 100));
        Swal.fire({
          icon: "warning",
          title: "ØªÙ†Ø¨ÙŠÙ‡",
          text: "Ø±Ù‚Ù… ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø²ÙˆØ¬(Ø©) ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙƒÙˆÙ† Ù…Ù† 16 Ø±Ù‚Ù…Ù‹Ø§",
          confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
          allowOutsideClick: true,
          allowEscapeKey: true
        });
        submitBtn.disabled = false;
        submitBtn.style.opacity = 1;
        return;
      }

      if (spouseId === empId) {
        Swal.close();
        await new Promise(resolve => setTimeout(resolve, 100));
        Swal.fire({
          icon: "warning",
          title: "ØªÙ†Ø¨ÙŠÙ‡",
          text: "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…ÙˆØ¸Ù ÙƒØ±Ù‚Ù… Ù„Ù„Ø²ÙˆØ¬(Ø©)",
          confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
          allowOutsideClick: true,
          allowEscapeKey: true
        });
        submitBtn.disabled = false;
        submitBtn.style.opacity = 1;
        return;
      }

      if (!spouseName) {
        Swal.close();
        await new Promise(resolve => setTimeout(resolve, 100));
        Swal.fire({
          icon: "warning",
          title: "ØªÙ†Ø¨ÙŠÙ‡",
          text: "ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø²ÙˆØ¬(Ø©) Ù‚Ø¨Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©",
          confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
          allowOutsideClick: true,
          allowEscapeKey: true
        });
        submitBtn.disabled = false;
        submitBtn.style.opacity = 1;
        return;
      }
    } else if (spouseStatus === "Ù…ØªÙ‚Ø§Ø¹Ø¯(Ø©)") {
      if (!spouseName) {
        Swal.close();
        await new Promise(resolve => setTimeout(resolve, 100));
        Swal.fire({
          icon: "warning",
          title: "ØªÙ†Ø¨ÙŠÙ‡",
          text: "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø²ÙˆØ¬(Ø©)",
          confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
          allowOutsideClick: true,
          allowEscapeKey: true
        });
        submitBtn.disabled = false;
        submitBtn.style.opacity = 1;
        return;
      }
    }
  }


  // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ† Ø§Ù„Ø³Ø§Ø¨Ù‚ÙŠÙ† Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø­Ù…Ø§ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ©)
  if (!isEditMode) {
    try {
      const beneficiaryParams = new URLSearchParams();
      beneficiaryParams.append("action", "check_previous_beneficiary");
      beneficiaryParams.append("empId", empId);
      beneficiaryParams.append("loanType", "exceptional");

      const beneficiaryRes = await fetch(scriptURL, {
        method: "POST",
        body: beneficiaryParams
      });
      const beneficiaryResult = await beneficiaryRes.json();

      if (beneficiaryResult.result === "previous_beneficiary") {
        Swal.close();
        await new Promise(resolve => setTimeout(resolve, 100));
        Swal.fire({
          title: "âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ³Ø¬ÙŠÙ„",
          html: `
            <div style="text-align:center;direction:rtl;font-family:'Cairo',sans-serif;">
              <p style="color:#dc3545;font-weight:600;margin-bottom:15px;font-size:18px;">
                ${beneficiaryResult.message || 'Ø£Ù†Øª Ù…Ø³ØªÙÙŠØ¯(Ø©) Ù…Ù† Ø§Ù„Ù…Ø®ÙŠÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©'}
              </p>
              <p style="color:#666;font-size:14px;">
                Ù„Ø§ ÙŠØ­Ù‚Ù‘ Ù„Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø°ÙŠ Ø§Ø³ØªÙØ§Ø¯ Ù…Ù† Ù…Ø®ÙŠÙ…Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ© Ø®Ù„Ø§Ù„ Ø§Ù„Ø³Ù†Ø© Ù†ÙØ³Ù‡Ø§ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ØŒ ÙˆØ°Ù„Ùƒ Ø¹Ù…Ù„Ø§Ù‹ Ø¨Ø§Ù„Ø£Ø­ÙƒØ§Ù… Ø§Ù„Ù…Ø¹Ù…ÙˆÙ„ Ø¨Ù‡Ø§.
              </p>
            </div>
          `,
          icon: "error",
          confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
          confirmButtonColor: "#dc3545"
        });
        submitBtn.disabled = false;
        submitBtn.style.opacity = 1;
        return;
      }
    } catch (err) {
      console.error("check_previous_beneficiary error:", err);
      // Ù†ØªØ§Ø¨Ø¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ (Ù„Ø£Ù† Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ØªÙ… ÙÙŠ checkEmployee)
    }
  }

  // âœ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ action=register Ø£Ùˆ update
  // âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©: ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¯Ø¹Ù… Ø³ÙƒØ±ÙŠØ¨Øª Google Apps action="update" Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø¯Ø¹ÙˆÙ…Ø§Ù‹ØŒ Ø³ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø© update ÙÙŠ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª
  const params = new URLSearchParams();
  
  params.append("action", isEditMode ? "update" : "register"); // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… update ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  params.append("empId", empId);
  params.append("loanType", "exceptional"); // âœ… Ù†ÙˆØ¹ Ø§Ù„Ø³Ù„ÙØ©: Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠØ©
  params.append("name", name);
  params.append("birthDate", birthDate);
  params.append("grade", grade);
  params.append("place", place);
  params.append("personalPhone", personalPhone);
  params.append("daira", daaira); // âœ… Ø¨Ø¯Ù„ daaira
  params.append("baladiya", baladiya);
  params.append("maritalStatus", maritalStatus);
  params.append("childrenCount", childrenCount);
  params.append("dualSector", dualSector);
  params.append("spouseEmpId", spouseId);
  params.append("spouseName", spouseName);
  params.append("spouseStatus", spouseStatus);
  params.append("guarantee", guarantee);
  params.append("guaranteedCount", guaranteedCount);
  params.append("destination", destination);
  params.append("cohort", cohort);
  
  // âœ… Ø¥Ø¶Ø§ÙØ© ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙ‚Ø· ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  if (isEditMode) {
    const now = new Date();
    const day = String(now.getDate()).padStart(2, '0');
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const year = now.getFullYear();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    const modificationDate = `${hours}:${minutes}:${seconds} ll ${year}-${month}-${day}`;
    currentModificationDate = modificationDate; // Ø­ÙØ¸ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ
    params.append("modificationDate", modificationDate);
  } else {
    currentModificationDate = null; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
  }

  try {
    const res = await fetch(scriptURL, {
      method: "POST",
      body: params
    });
    const data = await res.json();

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù„ØªØ´Ø®ÙŠØµ
    console.log("Response from server:", data);
    console.log("Is edit mode:", isEditMode);
    console.log("Action sent:", isEditMode ? "update" : "register");

if (data.result === "success") {
  Swal.close();
  await new Promise(resolve => setTimeout(resolve, 100));
  const receiptButtonId = isEditMode ? "editReceiptBtn" : "registerReceiptBtn";
  const submittedSnapshot = snapshotFormValues();
  const receiptOptions = {
    actionSource: isEditMode ? "ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª" : "ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯",
    registrationDate: isEditMode 
      ? (originalRegistrationDate || data.date || new Date().toISOString())
      : (data.date || new Date().toISOString()),
    modificationDate: isEditMode 
      ? (data.modificationDate || currentModificationDate || "")
      : ""
  };

  Swal.fire({
    title: isEditMode ? "âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­" : "âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­",
    html: `
      <p style="margin-bottom:12px;">
        ${isEditMode ? "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø®ÙŠÙ…Øª Ø¨Ù†Ø¬Ø§Ø­" : "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø®ÙŠÙ…Ø§Øª Ø¨Ù†Ø¬Ø§Ø­"}
      </p>
      <button type="button" class="receipt-download-btn" id="${receiptButtonId}">ØªØ­Ù…ÙŠÙ„ ÙˆØµÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
    `,
    icon: "success",
    confirmButtonText: "Ø¥ØºÙ„Ø§Ù‚",
    didOpen: () => {
      attachReceiptButton(receiptButtonId, submittedSnapshot, receiptOptions);
    }
  }).then(() => {
    location.reload(); // Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ ÙŠØ¹ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ÙÙ‚Ø·
  });

} else if (data.result === "previous_beneficiary") {
  Swal.close();
  await new Promise(resolve => setTimeout(resolve, 100));
  Swal.fire({
    title: "âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ³Ø¬ÙŠÙ„",
    html: `
      <div style="text-align:center;direction:rtl;font-family:'Cairo',sans-serif;">
        <p style="color:#dc3545;font-weight:600;margin-bottom:15px;font-size:18px;">
          ${data.message || 'Ø£Ù†Øª Ù…Ø³ØªÙÙŠØ¯(Ø©) Ù…Ù† Ø§Ù„Ù…Ø®ÙŠÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©'}
        </p>
        <p style="color:#666;font-size:14px;">
        Ù„Ø§ ÙŠØ­Ù‚Ù‘ Ù„Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø°ÙŠ Ø§Ø³ØªÙØ§Ø¯ Ù…Ù† Ù…Ø®ÙŠÙ…Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ© Ø®Ù„Ø§Ù„ Ø§Ù„Ø³Ù†Ø© Ù†ÙØ³Ù‡Ø§ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ØŒ ÙˆØ°Ù„Ùƒ Ø¹Ù…Ù„Ø§Ù‹ Ø¨Ø§Ù„Ø£Ø­ÙƒØ§Ù… Ø§Ù„Ù…Ø¹Ù…ÙˆÙ„ Ø¨Ù‡Ø§.
        </p>
      </div>
    `,
    icon: "error",
    confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
    confirmButtonColor: "#dc3545"
  });
  submitBtn.disabled = false;
  submitBtn.style.opacity = 1;

} else if (data.result === "exists") {
      Swal.close();
      await new Promise(resolve => setTimeout(resolve, 100));
      const d = data.data || {};
      const birthLine = formatToDayMonthYear(d.birthDate || d.diz || '');
        const childrenValue = (d.childrenCount ?? "").toString().trim();
        const isFamilyStatusRequiringChildren = ["Ù…ØªØ²ÙˆØ¬(Ø©)", "Ù…Ø·Ù„Ù‚(Ø©)"].includes(d.maritalStatus);
        const hasChildrenValue = childrenValue !== "";
        const shouldRenderChildren = hasChildrenValue || isFamilyStatusRequiringChildren;
        const childrenLine = shouldRenderChildren ? `<b>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆÙ„Ø§Ø¯:</b> ${childrenValue || "0"}<br>` : "";
  const dualSectorLine = isFamilyStatusRequiringChildren
    ? `<b>Ø«Ù†Ø§Ø¦ÙŠ Ø§Ù„Ù‚Ø·Ø§Ø¹:</b> ${d.dualSector || ''}<br>`
    : "";
  const spouseStatusLine = isFamilyStatusRequiringChildren && d.spouseStatus
    ? `<b>ØµÙØ© Ø§Ù„Ø²ÙˆØ¬(Ø©):</b> ${d.spouseStatus}<br>`
    : "";
  // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø²ÙˆØ¬ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø«Ù†Ø§Ø¦ÙŠ Ø§Ù„Ù‚Ø·Ø§Ø¹ = Ù†Ø¹Ù…
  let spouseBlock = "";
  if (d.dualSector === "Ù†Ø¹Ù…") {
    if (d.spouseEmpId) {
      spouseBlock += `<b>Ø±Ù‚Ù… ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø²ÙˆØ¬(Ø©):</b> ${d.spouseEmpId}<br>`;
    }
    if (d.spouseName) {
      spouseBlock += `<b>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø²ÙˆØ¬(Ø©):</b> ${d.spouseName}<br>`;
    }
  }
  const guaranteeBlock = d.guarantee
    ? `<b>Ø§Ù„ÙƒÙØ§Ù„Ø©:</b> ${d.guarantee}<br>${d.guarantee === "Ù†Ø¹Ù…" && d.guaranteedCount ? `<b>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙØ±Ø§Ø¯ Ø§Ù„Ù…ÙƒÙÙˆÙ„ÙŠÙ†:</b> ${d.guaranteedCount}<br>` : ''}`
    : "";
  const destinationLine = d.destination ? `<b>Ø§Ù„ÙˆØ¬Ù‡Ø©:</b> ${d.destination}<br>` : "";
  const cohortLine = d.cohort ? `<b>Ø§Ù„ÙÙˆØ¬:</b> ${d.cohort}<br>` : "";

  Swal.fire({
    title: "âš ï¸ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§",
    html: `
      <div style="text-align:right;direction:rtl;font-family:'Cairo',sans-serif;">
        <b>Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ:</b> ${d.empId || ''}<br>
        <b>Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù„Ù‚Ø¨:</b> ${d.name || ''}<br>
        <b>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:</b> ${birthLine}<br>
        <b>Ø§Ù„Ø±ØªØ¨Ø©:</b> ${d.grade || ''}<br>
        <b>Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„:</b> ${d.place || ''}<br>
        <b>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</b> <span style="direction:ltr;unicode-bidi:bidi-override;display:inline-block;text-align:left;">${formatPhoneNumber(d.personalPhone || '')}</span><br>
        <b>Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©:</b> ${d.daira || ''}<br>
        <b>Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©:</b> ${d.baladiya || ''}<br>
        <b>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„ÙŠØ©:</b> ${d.maritalStatus || ''}<br>
        ${childrenLine}
        ${dualSectorLine}
        ${spouseStatusLine}
        ${spouseBlock}
        ${guaranteeBlock}
        ${destinationLine}
        ${cohortLine}
        <b>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</b> <span style="direction:ltr;unicode-bidi:bidi-override;display:inline-block;text-align:left;">${formatDateFromISO(d.date || '')}</span>${d.modificationDate ? `<br><b>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:</b> <span style="direction:ltr;unicode-bidi:bidi-override;display:inline-block;text-align:left;">${formatDateFromISO(d.modificationDate || '')}</span>` : ''}
      </div>
      <button type="button" class="receipt-download-btn" id="receiptExistsSubmitBtn">ØªØ­Ù…ÙŠÙ„ ÙˆØµÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
    `,
    icon: "warning",
    confirmButtonText: "Ø¥ØºÙ„Ø§Ù‚",
    didOpen: () => {
      attachReceiptButton("receiptExistsSubmitBtn", d, {
        actionSource: "Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ù…ÙƒØ±Ø±Ø©",
        registrationDate: d.date,
        modificationDate: d.modificationDate
      });
    }
  }).then(() => location.reload());

} else if (data.result === "email_exists") {
  Swal.close();
  await new Promise(resolve => setTimeout(resolve, 100));
  Swal.fire({
    icon: "warning",
    title: "âš ï¸ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ¹Ù…Ù„",
    text: "Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø±ÙŠØ¯ Ø¢Ø®Ø±.",
    confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
    allowOutsideClick: true,
    allowEscapeKey: true
  });

  // âœ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø°ÙŠØ±
  submitBtn.disabled = false;
  submitBtn.style.opacity = 1;



} else if (data.result === "phone_exists") {
  Swal.close();
  await new Promise(resolve => setTimeout(resolve, 100));
  Swal.fire({
    icon: "warning",
    title: "âš ï¸ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ø³ØªØ¹Ù…Ù„",
    text: "Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù‚Ù….",
    confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
    allowOutsideClick: true,
    allowEscapeKey: true
  });

  // âœ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø°ÙŠØ±
  submitBtn.disabled = false;
  submitBtn.style.opacity = 1;




} else {
  // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„ØªØ´Ø®ÙŠØµ
  Swal.close();
  await new Promise(resolve => setTimeout(resolve, 100));
  const errorMsg = data.message || data.error || "ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
  console.error("Error response:", data);
  Swal.fire({
    icon: "error",
    title: "âŒ Ø®Ø·Ø£",
    text: errorMsg + (isEditMode ? " Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ù† Ø¬Ø¯ÙŠØ¯" : ""),
    confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
    allowOutsideClick: true,
    allowEscapeKey: true
  });
  submitBtn.disabled = false;
  submitBtn.style.opacity = 1;
}


  } catch (error) {
    console.error("Fetch error:", error);
    Swal.close();
    await new Promise(resolve => setTimeout(resolve, 100));
    Swal.fire({
      icon: "error",
      title: "âŒ Ø®Ø·Ø£",
      text: "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø¯Ù…Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„: " + error.message,
      confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
      allowOutsideClick: true,
      allowEscapeKey: true
    });
    submitBtn.disabled = false; 
    submitBtn.style.opacity = 1;
  }
}

// Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ù† Google Sheet
async function deleteRegistration(empId) {
  // Ø·Ù„Ø¨ ØªØ£ÙƒÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù
  const confirmResult = await Swal.fire({
    title: "âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù",
    text: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù",
    cancelButtonText: "Ø¥Ù„ØºØ§Ø¡",
    confirmButtonColor: "#dc3545",
    cancelButtonColor: "#6c757d"
  });

  if (!confirmResult.isConfirmed) {
    return; // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ù„ØºÙ‰ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
  }

  Swal.fire({ 
    title: 'Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„...', 
    allowOutsideClick: false, 
    didOpen: () => Swal.showLoading() 
  });

  try {
    const params = new URLSearchParams();
    params.append("action", "delete");
    params.append("empId", empId);
    params.append("loanType", "exceptional"); // âœ… Ù†ÙˆØ¹ Ø§Ù„Ø³Ù„ÙØ©: Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠØ©

    const res = await fetch(scriptURL, {
      method: "POST",
      body: params
    });

    const data = await res.json();

    Swal.close();
    await new Promise(resolve => setTimeout(resolve, 100));

    if (data.result === "success") {
      Swal.fire({
        title: "âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­",
        text: "ØªÙ… Ø­Ø°Ù ØªØ³Ø¬ÙŠÙ„Ùƒ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø®ÙŠÙ…Ø§Øª Ø¨Ù†Ø¬Ø§Ø­",
        icon: "success",
        confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
        allowOutsideClick: true,
        allowEscapeKey: true
      }).then(() => {
        location.reload(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù
      });
    } else if (data.result === "not_found") {
      Swal.fire({
        title: "âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØªØ³Ø¬ÙŠÙ„",
        text: "Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
        icon: "warning",
        confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
        allowOutsideClick: true,
        allowEscapeKey: true
      });
    } else {
      const errorMsg = data.message || data.error || "ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„";
      Swal.fire({
        icon: "error",
        title: "âŒ Ø®Ø·Ø£",
        text: errorMsg,
        confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
        allowOutsideClick: true,
        allowEscapeKey: true
      });
    }
  } catch (error) {
    console.error("Delete error:", error);
    Swal.close();
    await new Promise(resolve => setTimeout(resolve, 100));
    Swal.fire({
      icon: "error",
      title: "âŒ Ø®Ø·Ø£",
      text: "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø¯Ù…Ø© Ø§Ù„Ø­Ø°Ù: " + error.message,
      confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
      allowOutsideClick: true,
      allowEscapeKey: true
    });
  }
}    

 // ğŸ”’ ØªØ­ÙƒÙ… ÙÙŠ ÙØªØ­ ÙˆØºÙ„Ù‚ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ù† Ù‡Ù†Ø§
  const registrationOpen = true; // â† ØºÙŠÙ‘Ø± Ø¥Ù„Ù‰ true Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­

  window.onload = function() {
    const container = document.querySelector(".container");
    const empInput = getEl("empId");
    const checkBtn = container?.querySelector("button");

    if (!registrationOpen) {
      // Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ²Ø± Ø§Ù„ØªØ­Ù‚Ù‚
      empInput.style.display = "none";
      checkBtn.style.display = "none";

      // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
      const msg = document.createElement("div");
      msg.innerHTML = `
        <div style="
          background: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
          border-radius: 10px;
          padding: 15px;
          margin-top: 0px;
           margin-bottom: 20px;
          font-size: 20px;
          font-weight: 600;">
           Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…ØºÙ„Ù‚ Ø­Ø§Ù„ÙŠÙ‹Ø§<br>Ø³ÙŠØªÙ… ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù‚Ø±ÙŠØ¨Ø§...
        </div>`;
      container.appendChild(msg);
    }
  };   

</script>
</body>
</html>












