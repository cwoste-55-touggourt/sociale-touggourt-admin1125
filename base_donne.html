<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>قاعدة بيانات الموظفين</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body {
  font-family: Cairo;
  background: #f4f6fb;
  margin: 0;
  padding: 20px;
}

header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

h2 { color: #0d47a1; margin: 0; }

input {
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #ccc;
  font-family: Cairo;
}
.search-input {
  min-width: 320px;
  flex: 1 1 420px;
  max-width: 620px;
}

button {
  border: none;
  padding: 10px 14px;
  border-radius: 10px;
  cursor: pointer;
  font-family: Cairo;
  transition: transform 0.08s ease, box-shadow 0.12s ease;
}

button:active,
.actions button:active {
  transform: scale(0.97);
  box-shadow: 0 0 0 3px rgba(25,118,210,0.15);
}

.add-btn { background: #1976d2; color: white; }
.back-btn { background: #607d8b; color: white; }

.stats {
  margin: 15px 0;
  font-weight: bold;
  color: #333;
}

.swal2-popup { font-family: Cairo; }
.swal2-input {
  width: calc(100% - 24px);
  margin: 6px 12px;
  border-radius: 12px;
  border: 1px solid #cfd8dc;
  padding: 10px 12px;
  text-align: center;
}
.swal2-input:focus {
  border-color: #1976d2;
  box-shadow: 0 0 0 3px rgba(25,118,210,0.15);
}
.swal2-label {
  display: block;
  margin: 6px 12px 2px;
  font-size: 13px;
  color: #0d47a1;
  text-align: right;
}

.table-wrap { overflow-x: auto; }

table {
  width: 100%;
  background: white;
  border-collapse: collapse;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
  table-layout: fixed;
}

th {
  background: #1976d2;
  color: white;
  padding: 12px;
}

td {
  padding: 10px;
  border-bottom: 1px solid #eee;
}

tr:hover { background: #e3f2fd; }

.actions button {
  margin: 2px;
  font-size: 14px;
}

.edit { background: #ffca28; }
.delete { background: #ef5350; color: white; }
.hidden-row { display: none !important; }

#loading {
  position: fixed;
  inset: 0;
  background: rgba(255,255,255,0.9);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.spinner {
  width: 60px;
  height: 60px;
  border: 6px solid #e3f2fd;
  border-top: 6px solid #1976d2;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>

<body>

<div id="loading"><div class="spinner"></div></div>

<header>
  <h2>قاعدة بيانات الموظفين</h2>
  <input id="search" class="search-input" placeholder="ابحث عن موظف...">
  <button class="add-btn" onclick="openForm()">إضافة موظف جديد</button>
  <button class="back-btn" onclick="history.back()">رجوع</button>
</header>

<div class="stats">عدد الموظفين المسجلين: <span id="count">0</span></div>

<div class="table-wrap">
<table>
<thead>
<tr>
  <th>الرقم الوطني</th>
  <th>الاسم الكامل</th>
  <th>تاريخ الازدياد</th>
  <th>تاريخ التوظيف</th>
  <th>الرتبة</th>
  <th>مكان العمل</th>
  <th>إجراءات</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs, doc, setDoc, updateDoc, deleteDoc } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* إعداد Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyAkQz9pB2ZNlYIvdlTRvi4try3D8LLXS4g",
  authDomain: "databaseemploye.firebaseapp.com",
  projectId: "databaseemploye",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* تخزين مؤقت */
const CACHE = new Map();
const tbody = document.getElementById("tbody");
const count = document.getElementById("count");
const loading = document.getElementById("loading");
const searchInput = document.getElementById("search");

/* مؤشر التحميل */
const showLoading = () => { if (loading) { loading.style.display = "flex"; loading.setAttribute('aria-hidden','false'); } };
const hideLoading = () => { if (loading) { loading.style.display = "none"; loading.setAttribute('aria-hidden','true'); } };

/* تنسيق التاريخ */
const fmt = v => {
  if (!v && v !== 0) return "";
  try {
    let dt;
    if (typeof v === 'object' && v !== null && typeof v.toDate === 'function') {
      dt = v.toDate();
    } else {
      dt = new Date(v);
    }
    if (!isFinite(dt.getTime())) return "";
    return dt.toISOString().slice(0,10);
  } catch (e) {
    console.warn('fmt: invalid date value', v, e);
    return "";
  }
};

/* أدوات مساعدة */
const debounce = (fn, delay = 250) => {
  let t;
  return (...args) => {
    clearTimeout(t);
    t = setTimeout(() => fn(...args), delay);
  };
};

const htmlEscape = v => String(v ?? "")
  .replace(/&/g,"&amp;")
  .replace(/</g,"&lt;")
  .replace(/>/g,"&gt;")
  .replace(/"/g,"&quot;")
  .replace(/'/g,"&#39;");

const rowMarkup = (id, d) => {
  const nm = htmlEscape(d?.name ?? "");
  const gr = htmlEscape(d?.grade ?? "");
  const pl = htmlEscape(d?.place ?? "");
  const diz = htmlEscape(fmt(d?.diz));
  const dtw = htmlEscape(fmt(d?.dtw));
  const safeId = htmlEscape(id);
  const searchKey = htmlEscape(`${id} ${d?.name ?? ""} ${d?.grade ?? ""} ${d?.place ?? ""}`.toLowerCase());
  return `
    <tr data-id="${safeId}" data-search="${searchKey}">
      <td>${safeId}</td>
      <td>${nm}</td>
      <td>${diz}</td>
      <td>${dtw}</td>
      <td>${gr}</td>
      <td>${pl}</td>
      <td class="actions">
        <button class="edit" onclick="openForm('${id}')">تعديل</button>
        <button class="delete" onclick="removeEmp('${id}')">حذف</button>
      </td>
    </tr>`;
};

let rowCache = [];
let currentFilter = "";
const syncRowCache = () => { rowCache = Array.from(tbody.rows); };

const runFilter = term => {
  currentFilter = term;
  const q = term.trim().toLowerCase();
  if (!rowCache.length) return;
  if (!q) {
    rowCache.forEach(tr => tr.classList.remove('hidden-row'));
    return;
  }
  rowCache.forEach(tr => {
    const match = (tr.dataset.search || "").includes(q);
    tr.classList.toggle('hidden-row', !match);
  });
};

const scheduleFilter = debounce(v => runFilter(v), 250);
if (searchInput) {
  searchInput.addEventListener("input", e => scheduleFilter(e.target.value || ""));
}

/* تحميل البيانات */
async function init() {
  showLoading();
  const loaderTimer = setTimeout(() => {
    if (loading && loading.style.display !== 'none') {
      hideLoading();
      console.error('Loading timeout');
      Swal.fire('تنبيه','تأخر الاتصال بالخادم، يرجى المحاولة لاحقاً','error');
    }
  }, 15000);

  try {
    const snap = await getDocs(collection(db, "employeescom"));
    snap.forEach(docu => {
      const data = docu.data();
      CACHE.set(docu.id, data);
    });
    renderAll();
  } catch (err) {
    console.error('Failed to load data:', err);
    Swal.fire('خطأ','تعذر تحميل البيانات: ' + (err.message || err),'error');
  } finally {
    clearTimeout(loaderTimer);
    hideLoading();
  }
}
init();

window.addEventListener('unhandledrejection', e => { console.error('Unhandled rejection', e); hideLoading(); });
window.addEventListener('error', e => { console.error('Global error', e.error || e.message || e); hideLoading(); });

/* Render سريع */
function renderAll() {
  const rows = [];
  CACHE.forEach((d,id) => rows.push(rowMarkup(id,d)));
  tbody.innerHTML = rows.join("");
  syncRowCache();
  count.textContent = CACHE.size;
  const activeFilter = searchInput ? searchInput.value : currentFilter;
  runFilter(activeFilter || "");
}

const upsertRow = (id, data) => {
  const html = rowMarkup(id, data);
  const existing = tbody.querySelector(`tr[data-id="${id}"]`);
  if (existing) {
    existing.outerHTML = html;
  } else {
    tbody.insertAdjacentHTML("beforeend", html);
  }
  syncRowCache();
  count.textContent = CACHE.size;
  runFilter(searchInput ? searchInput.value : currentFilter);
};

const removeRowDom = id => {
  const tr = tbody.querySelector(`tr[data-id="${id}"]`);
  if (tr) tr.remove();
  syncRowCache();
  count.textContent = CACHE.size;
  runFilter(searchInput ? searchInput.value : currentFilter);
};

/* نموذج إضافة/تعديل */
window.openForm = (id=null) => {
  const d = id ? CACHE.get(id) : {};
  Swal.fire({
    title: id ? "تعديل بيانات الموظف" : "إضافة موظف جديد",
    html: `
      <label class="swal2-label" for="fid">الرقم الوطني (16 رقم)</label>
      <input id="fid" class="swal2-input" placeholder="الرقم الوطني" value="${id||""}" ${id?"disabled":""}>
      <label class="swal2-label" for="fname">الاسم الكامل</label>
      <input id="fname" class="swal2-input" placeholder="الاسم الكامل" value="${d?.name||""}">
      <label class="swal2-label" for="fdiz">تاريخ الازدياد</label>
      <input id="fdiz" type="date" class="swal2-input" value="${fmt(d?.diz)}">
      <label class="swal2-label" for="fdtw">تاريخ التوظيف</label>
      <input id="fdtw" type="date" class="swal2-input" value="${fmt(d?.dtw)}">
      <label class="swal2-label" for="fgrade">الرتبة</label>
      <input id="fgrade" class="swal2-input" placeholder="الرتبة" value="${d?.grade||""}">
      <label class="swal2-label" for="fplace">مكان العمل</label>
      <input id="fplace" class="swal2-input" placeholder="مكان العمل" value="${d?.place||""}">
    `,
    preConfirm: async () => {
      const fid = document.getElementById("fid").value;
      const fnameEl = document.getElementById("fname");
      const fdizEl = document.getElementById("fdiz");
      const fdtwEl = document.getElementById("fdtw");
      const fgradeEl = document.getElementById("fgrade");
      const fplaceEl = document.getElementById("fplace");

      if (!/^\d{16}$/.test(fid)) return Swal.showValidationMessage("الرقم الوطني يجب أن يكون 16 رقماً");
      if (!id && CACHE.has(fid)) return Swal.showValidationMessage("الموظف موجود بالفعل");

      const data = {
        id: fid,
        name: fnameEl ? fnameEl.value : "",
        diz: fdizEl ? fdizEl.value : "",
        dtw: fdtwEl ? fdtwEl.value : "",
        grade: fgradeEl ? fgradeEl.value : "",
        place: fplaceEl ? fplaceEl.value : ""
      };

      showLoading();
      try {
        if (id) {
          await updateDoc(doc(db,"employeescom",id),data);
        } else {
          await setDoc(doc(db,"employeescom",fid),data);
        }
        CACHE.set(fid,data);
        upsertRow(fid,data);
        Swal.fire("تم الحفظ","تم حفظ بيانات الموظف بنجاح","success");
      } catch (err) {
        console.error('Save error', err);
        Swal.showValidationMessage('حدث خطأ أثناء الحفظ: ' + (err.message || err));
      } finally {
        hideLoading();
      }
    }
  });
};

/* حذف */
window.removeEmp = async id => {
  const confirm = await Swal.fire({
    title:"هل أنت متأكد؟",
    text:"سيتم حذف الموظف نهائياً",
    icon:"warning",
    showCancelButton:true,
    confirmButtonText:"نعم، احذف",
    cancelButtonText:"إلغاء"
  }).then(r=>r.isConfirmed);
  if (!confirm) return;
  showLoading();
  try {
    await deleteDoc(doc(db,"employeescom",id));
    CACHE.delete(id);
    removeRowDom(id);
    Swal.fire("تم الحذف","تم حذف الموظف بنجاح","success");
  } catch (err) {
    console.error('Delete error', err);
    Swal.fire('خطأ','حدث خطأ أثناء الحذف: ' + (err.message || err),'error');
  } finally {
    hideLoading();
  }
};
</script>

</body>
</html>
